<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NEURAL DRIVE // ASSET DETAIL</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;600;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Cyberpunk Palette 2.0 (Inherited from Index) */
      --bg-core: #050505;
      --bg-panel: rgba(10, 15, 20, 0.7);
      --neon-cyan: #00f3ff;
      --neon-magenta: #ff0055;
      --neon-yellow: #fcee0a;
      --grid-color: rgba(0, 243, 255, 0.07);
      --border-dim: rgba(0, 243, 255, 0.15);
      --text-main: #e0f7fa;
      --text-muted: #617d8a;
      --font-hud: 'Rajdhani', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --sim-cols: 2; /* Dynamic Column Var */
    }

    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0; background-color: var(--bg-core); color: var(--text-main);
      font-family: var(--font-hud);
      background-image:
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px),
        radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.1) 0%, transparent 60%);
      background-size: 40px 40px, 40px 40px, 100% 100%;
      background-position: center top;
      height: 100vh; overflow: hidden;
    }
    body::after {
      content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
      background-size: 100% 3px; z-index: 2; pointer-events: none; opacity: 0.4;
    }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-dim); height: 70px;
      display: flex; align-items: center; padding: 0 32px;
      box-shadow: 0 5px 20px rgba(0, 243, 255, 0.05);
    }

    .brand {
      display: flex; align-items: center; gap: 16px;
      font-family: var(--font-hud); font-weight: 700; font-size: 24px; letter-spacing: 2px;
      color: #fff; text-shadow: 0 0 10px var(--neon-cyan); cursor: pointer;
    }
    .logo {
      width: 40px; height: 40px; background: var(--neon-cyan); color: #000;
      clip-path: polygon(20% 0%, 100% 0, 100% 80%, 80% 100%, 0 100%, 0% 20%);
      display: grid; place-items: center; font-size: 22px;
    }

    /* Layout */
    .wrap {
      max-width: 1600px; margin: 0 auto; padding: 20px 32px;
      height: calc(100vh - 70px); position: relative; z-index: 5;
      display: grid; grid-template-columns: 1fr 420px; gap: 32px;
    }
    @media (max-width: 1100px){ .wrap { grid-template-columns: 1fr; overflow-y: auto; } }

    /* Panels */
    .panelBox {
      background: var(--bg-panel); border: 1px solid var(--border-dim);
      clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
      position: relative; padding: 24px; display: flex; flex-direction: column;
      height: 100%; overflow: hidden;
    }
    .panelBox::before {
      content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
      background: var(--neon-cyan); box-shadow: 2px 0 10px var(--neon-cyan);
    }

    /* Main Image Area */
    .detail-header {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border-dim); padding-bottom: 16px; margin-bottom: 16px;
    }
    .nav-btn {
      font-family: var(--font-mono); font-size: 12px; color: var(--neon-cyan);
      background: transparent; border: 1px solid var(--border-dim);
      padding: 8px 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
      transition: all 0.2s; text-decoration: none; display: inline-block;
    }
    .nav-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

    .imgbox {
      flex: 1; display: flex; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.3); border: 1px dashed var(--border-dim);
      margin-bottom: 16px; position: relative; overflow: hidden;
    }
    .imgbox img {
      max-width: 100%; max-height: 100%; object-fit: contain;
      box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
    }
    .meta {
      font-family: var(--font-mono); font-size: 12px; color: var(--text-muted);
      padding: 12px; background: rgba(0,0,0,0.5); border-left: 2px solid var(--neon-yellow);
    }

    /* Sidebar (Similar) */
    .side-header {
      font-family: var(--font-mono); color: var(--neon-yellow);
      font-size: 14px; text-transform: uppercase; margin-bottom: 16px;
      display: flex; align-items: center; gap: 10px;
    }
    .side-header::after { content: ''; flex: 1; height: 1px; background: var(--border-dim); }

    .side-scroll { flex: 1; overflow-y: auto; padding-right: 8px; }

    .grid {
      display: grid; grid-template-columns: repeat(var(--sim-cols), 1fr); gap: 16px;
    }

    .thumb-card {
      border: 1px solid var(--border-dim); background: rgba(0,0,0,0.4);
      text-decoration: none; color: inherit; display: block; transition: all 0.2s;
      position: relative;
    }
    .thumb-card:hover {
      border-color: var(--neon-cyan); transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 243, 255, 0.1);
    }
    .thumb-card img {
      width: 100%; height: 120px; object-fit: cover; display: block;
      filter: grayscale(40%); transition: filter 0.2s;
    }
    .thumb-card:hover img { filter: grayscale(0%); }
    .thumb-info {
      padding: 8px; font-family: var(--font-mono); font-size: 10px;
      display: flex; justify-content: space-between; color: var(--text-muted);
    }
    .score { color: var(--neon-cyan); }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: var(--border-dim); }
    ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }
  </style>
</head>
<body>

<header>
  <div class="brand" onclick="location.href='/'">
    <div class="logo">N</div>
    <div>NEURAL DRIVE <small style="font-size: 10px; color:var(--neon-magenta);">// ASSET.VIEWER</small></div>
  </div>
</header>

<div class="wrap">
  <!-- Left: Main Image -->
  <div class="panelBox">
    <div class="detail-header">
      <a href="/" class="nav-btn">← BACK TO GRID</a>
      <div id="title" style="font-family:var(--font-mono); color:var(--neon-cyan)">LOADING ASSET...</div>
      <a id="btnDownload" href="#" class="nav-btn">DOWNLOAD DATA</a>
    </div>
    <div class="imgbox">
      <img id="img" alt="Asset Preview"/>
    </div>
    <div class="meta" id="meta">Waiting for stream...</div>
  </div>

  <!-- Right: Similar Feed -->
  <div class="panelBox">
    <div class="side-header">/// SIMILAR PATTERNS DETECTED</div>
    <div class="side-scroll">
      <div class="grid" id="similar"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const id = parseInt(location.pathname.split('/').pop());
  const $ = s => document.querySelector(s);
  let currentSimCount = 0;

  function mimeToExt(mime){
    if(!mime) return '';
    const m = mime.toLowerCase();
    if(m.includes('jpeg') || m.includes('jpg')) return 'jpg';
    if(m.includes('png')) return 'png';
    if(m.includes('webp')) return 'webp';
    if(m.includes('gif')) return 'gif';
    return '';
  }

  async function downloadById(imgId, mimeHint){
    try{
      const url = `/api/images/${imgId}/download`;
      const resp = await fetch(url);
      if(!resp.ok) throw new Error('download failed');
      const blob = await resp.blob();
      const ext = mimeToExt(mimeHint) || mimeToExt(resp.headers.get('Content-Type')) || 'bin';
      const name = `asset-${imgId}.${ext}`;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }catch(e){ alert('Download failed.'); }
  }

  async function loadDetail(){
    try {
        const r = await fetch(`/api/images/${id}`);
        if(!r.ok) throw new Error("Asset not found");
        const j = await r.json();

        $('#title').innerHTML = `ASSET ID <span style="color:var(--text-main)">#${j.id}</span> [${j.width}×${j.height}]`;
        $('#img').src = `/api/images/${id}/view`;

        const btn = $('#btnDownload');
        btn.onclick = (e)=>{ e.preventDefault(); downloadById(j.id, j.mime || ''); };

        $('#meta').innerHTML = `HASH: ${j.sha256 || 'N/A'}<br>SIZE: ${Math.round((j.size_bytes||0)/1024)} KB<br>TYPE: ${j.mime||'UNKNOWN'}<br>TAG: ${j.category||'UNCATEGORIZED'}`;
    } catch(e) {
        $('#title').textContent = "ERROR LOADING ASSET";
    }
  }

  function setSimilarColumns(count){
    currentSimCount = count;
    // Logic adapted for side panel width ~400px
    let cols = 2;
    if (window.innerWidth < 1200) cols = 3; // When stacked vertically, use more cols
    document.documentElement.style.setProperty('--sim-cols', cols);
  }
  window.addEventListener('resize', ()=>setSimilarColumns(currentSimCount));

  async function loadSimilar(){
    const res = await fetch(`/api/images/${id}/similar?k=24`);
    const j = await res.json();
    const list = Array.isArray(j) ? j : (j.items || j.results || []);
    setSimilarColumns(list.length);

    const box = $('#similar'); box.innerHTML='';
    if (!list.length){
      box.innerHTML = `<div style="padding:12px;color:var(--text-muted);font-family:var(--font-mono)">// NO MATCHES FOUND</div>`;
      return;
    }

    list.forEach(it=>{
      const iid = it.id ?? it.image_id ?? it.imageId;
      if (!iid) return;
      const score = (typeof it.score === 'number' ? it.score : (it.score01 ?? 0));

      const card = document.createElement('a');
      card.className='thumb-card'; card.href=`/image/${iid}`;

      const img = document.createElement('img');
      img.loading='lazy'; img.src=`/api/images/${iid}/thumb`;
      img.onerror = () => { img.onerror = null; img.src = `/api/images/${iid}/view`; };

      const info = document.createElement('div');
      info.className = 'thumb-info';
      info.innerHTML = `<span>#${iid}</span> <span class="score">${(score*100).toFixed(0)}%</span>`;

      card.appendChild(img); card.appendChild(info); box.appendChild(card);
    });
  }

  loadDetail();
  loadSimilar();
})();
</script>
</body>
</html>