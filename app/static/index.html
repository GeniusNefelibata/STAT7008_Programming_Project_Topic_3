<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEURAL DRIVE // 2077</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;600;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Cyberpunk Palette 2.0 (Static Neon) */
      --bg-core: #050505;
      --bg-panel: rgba(10, 15, 20, 0.7);

      --neon-cyan: #00f3ff;
      --neon-magenta: #ff0055;
      --neon-yellow: #fcee0a;

      --grid-color: rgba(0, 243, 255, 0.07);
      --border-dim: rgba(0, 243, 255, 0.15);
      --border-lit: rgba(0, 243, 255, 0.6);

      --text-main: #e0f7fa;
      --text-muted: #617d8a;

      --font-hud: 'Rajdhani', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; outline: none; }

    html, body { height: 100%; margin: 0; overflow: hidden; }

    body {
      background-color: var(--bg-core);
      color: var(--text-main);
      font-family: var(--font-hud);
      background-image:
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px),
        radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.1) 0%, transparent 60%);
      background-size: 40px 40px, 40px 40px, 100% 100%;
      background-position: center top;
      perspective: 1000px;
    }

    body::after {
      content: " "; display: block; position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
      background-size: 100% 3px; z-index: 2; pointer-events: none; opacity: 0.4;
    }

    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(5, 5, 5, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-dim);
      height: 70px; display: flex; align-items: center;
      box-shadow: 0 5px 20px rgba(0, 243, 255, 0.05);
    }

    .bar {
      width: 100%; max-width: 1600px; margin: 0 auto; padding: 0 32px;
      display: flex; align-items: center; justify-content: space-between;
    }

    .brand {
      display: flex; align-items: center; gap: 16px;
      font-family: var(--font-hud); font-weight: 700; font-size: 24px;
      letter-spacing: 2px; text-transform: uppercase;
      color: #fff; text-shadow: 0 0 10px var(--neon-cyan);
      cursor: pointer; transition: opacity 0.2s;
    }
    .brand:hover { opacity: 0.8; }

    .logo {
      width: 40px; height: 40px; background: var(--neon-cyan); color: #000;
      clip-path: polygon(20% 0%, 100% 0, 100% 80%, 80% 100%, 0 100%, 0% 20%);
      display: grid; place-items: center; font-size: 22px;
      animation: flicker 4s infinite;
    }

    @keyframes flicker {
      0%, 19.9%, 22%, 62.9%, 64%, 64.9%, 70%, 100% { opacity: 1; }
      20%, 21.9%, 63%, 63.9%, 65%, 69.9% { opacity: 0.5; }
    }

    .nav-btn {
      font-family: var(--font-mono); font-size: 12px; color: var(--neon-cyan);
      background: transparent; border: 1px solid var(--border-dim);
      padding: 8px 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
      transition: all 0.2s;
      position: relative; z-index: 10;
    }
    .nav-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

    .container {
      max-width: 1600px; margin: 0 auto; padding: 20px 32px;
      height: calc(100vh - 70px); display: flex; flex-direction: column;
      position: relative; z-index: 5;
    }

    .tabs {
      display: flex; justify-content: center; gap: 0; margin-bottom: 24px;
      border-bottom: 1px solid var(--border-dim); width: 100%;
      position: relative; z-index: 10;
    }
    .tab {
      padding: 12px 24px; font-family: var(--font-mono); font-size: 12px; color: var(--text-muted);
      cursor: pointer; background: linear-gradient(180deg, transparent 0%, transparent 90%, var(--border-dim) 90%);
      border-right: 1px solid var(--border-dim); transition: all 0.2s; position: relative;
    }
    .tab:first-child { border-left: 1px solid var(--border-dim); }
    .tab:hover { color: var(--neon-cyan); background: rgba(0, 243, 255, 0.05); }
    .tab.active { color: #000; background: var(--neon-cyan); font-weight: 700; box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }

    .split {
      display: grid; grid-template-columns: 480px 1fr; gap: 32px;
      height: 100%; align-items: start; overflow: hidden;
    }
    @media (max-width: 1100px) { .split { grid-template-columns: 1fr; overflow-y: auto; } .container { height: auto; } }

    .panelBox {
      background: var(--bg-panel); border: 1px solid var(--border-dim);
      clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
      position: relative; padding: 24px; height: 100%; display: flex; flex-direction: column;
    }

    .panelBox::before {
      content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
      background: var(--neon-cyan); box-shadow: 2px 0 10px var(--neon-cyan);
    }

    h3 {
      font-family: var(--font-mono); color: var(--neon-cyan);
      font-size: 16px; text-transform: uppercase; margin: 0 0 24px 0;
      display: flex; align-items: center; gap: 10px;
    }
    h3::after { content: ''; flex: 1; height: 1px; background: var(--border-dim); }

    .drop {
      border: 1px dashed var(--border-dim); background: rgba(0,0,0,0.3);
      padding: 40px 20px; text-align: center; color: var(--text-muted);
      font-family: var(--font-mono); font-size: 12px;
      transition: all 0.3s; cursor: pointer;
      position: relative; z-index: 20;
    }
    .drop:hover {
      border-color: var(--neon-cyan); color: #fff;
      background: rgba(0, 243, 255, 0.05); box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.1);
    }
    .drop::before, .drop::after { content: '+'; position: absolute; color: var(--neon-cyan); }
    .drop::before { top: 5px; left: 5px; }
    .drop::after { bottom: 5px; right: 5px; }

    .row { display: flex; gap: 12px; margin-top: 20px; }

    input[type="text"] {
      width: 100%; background: #000; border: 1px solid var(--border-dim);
      color: var(--neon-cyan); padding: 14px; font-family: var(--font-mono);
      transition: all 0.3s;
      position: relative; z-index: 20;
    }
    input[type="text"]:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }

    button {
      background: transparent; border: 1px solid var(--border-dim);
      color: var(--neon-cyan); padding: 12px 24px; cursor: pointer;
      font-family: var(--font-hud); font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
      transition: all 0.2s;
      position: relative; overflow: hidden; z-index: 20;
    }
    button:hover:not(:disabled) { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); }
    button:disabled { opacity: 0.3; cursor: not-allowed; }
    .btn-primary { background: rgba(0, 243, 255, 0.1); border-color: var(--neon-cyan); }

    .results-wrap {
      padding: 0; background: rgba(5, 5, 5, 0.5); border: 1px solid var(--border-dim);
    }

    .gridbar {
      padding: 20px 24px; border-bottom: 1px solid var(--border-dim);
      display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.4);
    }

    .results-scroll { flex: 1; overflow-y: auto; padding: 24px; padding-bottom: 120px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 24px; }

    .card {
      background: #0e1015; border: 1px solid var(--border-dim);
      position: relative; transition: all 0.3s ease;
      cursor: pointer;
    }
    .card::after {
      content: ''; position: absolute; top: -1px; right: -1px; width: 10px; height: 10px;
      border-top: 2px solid var(--neon-cyan); border-right: 2px solid var(--neon-cyan);
      opacity: 0.5; transition: all 0.3s;
      pointer-events: none;
    }
    .card:hover {
      transform: translateY(-5px); border-color: var(--neon-cyan);
      box-shadow: 0 10px 30px rgba(0, 243, 255, 0.1);
    }
    .card:hover::after { width: 100%; height: 100%; opacity: 1; }

    .card .thumb {
      width: 100%; aspect-ratio: 1; object-fit: cover;
      filter: grayscale(40%) contrast(1.1); transition: filter 0.3s;
      border-bottom: 1px solid var(--border-dim);
    }
    .card:hover .thumb { filter: grayscale(0%) contrast(1); }

    .card .body { padding: 12px; }
    .meta {
      font-family: var(--font-mono); font-size: 10px; color: var(--text-muted);
      display: flex; justify-content: space-between; margin-bottom: 8px;
    }
    .score { color: var(--neon-yellow); font-weight: bold; }

    .links { position: relative; z-index: 10; }
    .links a {
      font-family: var(--font-mono); font-size: 10px;
      color: var(--neon-cyan); text-decoration: none; margin-right: 12px;
      text-transform: uppercase; cursor: pointer;
      position: relative;
    }
    .links a:hover { text-shadow: 0 0 5px var(--neon-cyan); color: #fff; }
    .links a.danger { color: var(--neon-magenta); }

    .result-footer {
      position: absolute; bottom: 0; left: 0; right: 0; padding: 20px;
      background: linear-gradient(to top, #050505 80%, transparent);
      border-top: 1px solid var(--border-dim); display: flex; justify-content: center;
      backdrop-filter: blur(5px); z-index: 10;
      pointer-events: none; /* 允许点击穿透背景层 */
    }
    .view-more-btn {
      width: 100%; background: var(--neon-cyan); color: #000;
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      position: relative; z-index: 20;
      pointer-events: auto; /* 关键修复：恢复按钮点击 */
    }

    .pre { margin-top: 16px; }
    .pgrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; }
    .thumbbox { border: 1px solid var(--neon-cyan); position: relative; }

    .panel { display: none; }
    .panel.active { display: block; animation: glitch-in 0.3s forwards; }
    .pre.show { display: block; }

    @keyframes glitch-in {
      0% { opacity: 0; transform: translateX(-10px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: var(--border-dim); }
    ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }

    .modal, .prog {
        display: none; position: fixed; inset: 0; z-index: 200;
        background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px);
        align-items: center; justify-content: center;
    }
    .modal.show, .prog.show { display: flex; }

    .modal-card, .prog-card {
      background: #0a0f14; border: 1px solid var(--neon-cyan);
      box-shadow: 0 0 50px rgba(0, 243, 255, 0.2); font-family: var(--font-mono);
    }
    .bar { background: #000; }
    .bar > span { background: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--neon-cyan); color: #000; font-family: var(--font-mono);
      padding: 12px 32px; opacity: 0; transition: all 0.5s; pointer-events: none;
      box-shadow: 0 0 20px var(--neon-cyan); font-weight: bold; z-index: 200;
      border-radius: 0; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>
</head>
<body>

<header>
  <div class="bar">
    <!-- Logo 点击原地刷新 -->
    <div class="brand" onclick="location.href='http://127.0.0.1:5000/'">
      <div class="logo">N</div>
      <div>NEURAL DRIVE <small style="font-size: 10px; color:var(--neon-magenta); letter-spacing:0">// V.2077</small></div>
    </div>
    <div style="display:flex; gap: 20px;">
        <!-- 导航到 frontend 文件夹下的页面 -->
        <button class="nav-btn" onclick="location.href='/analytics'">SYS.ANALYTICS</button>
        <button class="nav-btn" onclick="location.href='/login'">NET.LOGIN</button>
    </div>
  </div>
</header>

<div class="container">

  <div class="tabs" id="tabs">
    <div class="tab active" data-target="upload">[01] INGEST</div>
    <div class="tab" data-target="text">[02] SEMANTIC</div>
    <div class="tab" data-target="image">[03] VISUAL</div>
    <div class="tab" data-target="ocr">[04] OCR-SCAN</div>
    <div class="tab" data-target="findid">[05] DB-INDEX</div>
    <!-- 关键修改：跳转到 gallery.html (位于 ../../frontend/) -->
    <div class="tab" id="tab-browse">[06] BROWSE</div>
  </div>

  <div class="split">
    <section class="panelBox">

      <section class="panel active" id="upload">
        <h3><span style="color:var(--neon-yellow)">//</span> Upload Protocol</h3>
        <div id="drop" class="drop">
          <div style="font-size: 24px; margin-bottom: 8px; opacity:0.8">◈</div>
          INITIATE DATA TRANSFER
          <br><span style="color:var(--text-muted)">DRAG ASSETS HERE</span>
        </div>
        <div class="row">
          <input multiple id="files" type="file" accept="image/*,.webp,.jpg,.jpeg,.png,.bmp" style="display:none" />
          <button onclick="document.getElementById('files').click()" style="flex:1">SELECT</button>
          <button id="btnUpload" class="btn-primary" disabled style="flex:1">EXECUTE</button>
        </div>
        <div id="pre" class="pre">
          <div style="display:flex; justify-content:space-between; font-family:var(--font-mono); font-size:10px; color:var(--neon-cyan); margin-bottom:8px">
            <span id="preInfo">BUFFER: EMPTY</span>
            <span onclick="document.getElementById('btnClear').click()" style="cursor:pointer; color:var(--neon-magenta)">[PURGE]</span>
            <button id="btnClear" style="display:none"></button>
          </div>
          <div id="pgrid" class="pgrid"></div>
        </div>
      </section>

      <section class="panel" id="text">
        <h3><span style="color:var(--neon-yellow)">//</span> Semantic Query</h3>
        <div class="row">
          <input id="qText" type="text" placeholder="ENTER QUERY PARAMETERS..."/>
        </div>
        <div class="row">
            <button id="btnQText" class="btn-primary" style="width:100%">RUN VECTOR SEARCH</button>
        </div>
      </section>

      <section class="panel" id="image">
        <h3><span style="color:var(--neon-yellow)">//</span> Visual Match</h3>
        <div class="drop" onclick="document.getElementById('qImg').click()">
            [LOAD REFERENCE PATTERN]
        </div>
        <input id="qImg" type="file" accept="image/*,.webp" style="display:none"/>
        <div class="row">
          <button id="btnQImg" class="btn-primary" style="width:100%">SCAN SIMILARITY</button>
        </div>
      </section>

      <section class="panel" id="ocr">
        <h3><span style="color:var(--neon-yellow)">//</span> Text Pattern</h3>
        <div class="row">
          <input id="qOCR" type="text" placeholder="INPUT TEXT SUBSTRING..."/>
        </div>
        <div class="row">
          <button id="btnQOCR" class="btn-primary" style="width:100%">SEARCH TEXT INDEX</button>
        </div>
      </section>

      <section class="panel" id="findid">
        <h3><span style="color:var(--neon-yellow)">//</span> Direct Access</h3>
        <div class="row">
          <input id="qId" type="text" placeholder="ASSET ID (INT)"/>
          <button id="btnFindId" class="btn-primary">FETCH</button>
        </div>
      </section>

      <section class="panel" id="browse">
        <h3><span style="color:var(--neon-yellow)">//</span> Library Stream</h3>
        <button id="btnBrowse" class="btn-primary" style="width:100%">REFRESH FEED</button>
      </section>

      <div style="margin-top:auto; padding-top:20px; font-family:var(--font-mono); font-size:10px; color:var(--text-muted); text-align:center; border-top:1px solid var(--border-dim)">
        SYSTEM READY <span style="color:var(--neon-cyan)">●</span>
      </div>
    </section>

    <section class="panelBox results-wrap">
      <div class="gridbar">
        <div style="font-family:var(--font-hud); font-weight:700; letter-spacing:1px; color:var(--neon-cyan)">OUTPUT STREAM</div>
        <div style="display:flex; gap: 10px;">
            <span class="hint" style="margin:0; align-self:center; margin-right:8px; font-family:var(--font-mono)">ORDER:</span>
            <button id="sortAsc" class="tab" style="padding:4px 12px; font-size:10px; height:auto;">ASC</button>
            <button id="sortDesc" class="tab active" style="padding:4px 12px; font-size:10px; height:auto;">DESC</button>
        </div>
      </div>

      <div class="results-scroll">
        <div class="grid" id="out"></div>
      </div>

      <div class="result-footer">
        <button class="view-more-btn" id="btnViewMore">ACCESS FULL GALLERY</button>
      </div>
    </section>
  </div>

</div>

<div class="prog" id="prog">
  <div class="prog-card" style="width: 450px; padding: 30px;">
    <div class="prog-title" style="margin-bottom:20px; display:flex; justify-content:space-between;">
        <strong style="color:var(--neon-cyan)">UPLOADING...</strong>
        <span id="overallPct" style="color:var(--neon-yellow)">0%</span>
    </div>
    <div class="bar"><span id="overallBar"></span></div>
    <div class="list" id="progList" style="margin-top:20px; max-height:150px; overflow-y:auto; font-size:10px; font-family:var(--font-mono); color:#aaa"></div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-card" style="max-width:400px; padding: 32px; text-align:center">
    <div style="font-size:40px; margin-bottom:10px; text-shadow:0 0 20px var(--neon-cyan)">◈</div>
    <h4 id="modalTitle" style="font-size:20px; margin-bottom:10px; color:var(--neon-cyan)">COMPLETE</h4>
    <p id="modalBody" style="color:var(--text-muted); margin-bottom:24px; line-height:1.5"></p>
    <button class="btn-primary" id="modalOk" style="width:100%">CONFIRM</button>
  </div>
</div>

<div class="toast" id="toast">OP_COMPLETE</div>

<script>
const $ = s => document.querySelector(s);
const api = p => (p && p.startsWith('http')) ? p : `${location.origin}${p}`;
const out = $('#out');

function normScore(s){ if(s==null || isNaN(s)) return null; const v=(s+1)/2; return Math.max(0,Math.min(1,v)); }
function scoreBadge(s){ const v=normScore(s); return v==null? '': `<span class="score">${(v*100).toFixed(1)}%</span>`; }
function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function openModal(title, body){ $('#modalTitle').textContent=title||'Notice'; $('#modalBody').textContent=body||''; $('#modal').classList.add('show'); }
function closeModal(){ $('#modal').classList.remove('show'); }
$('#modalOk').addEventListener('click', closeModal);
$('#modal').addEventListener('click', e=>{ if(e.target.id==='modal') closeModal(); });

function mimeToExt(mime){
  if(!mime) return '';
  const m = mime.toLowerCase();
  if(m.includes('jpeg') || m.includes('jpg')) return 'jpg';
  if(m.includes('png')) return 'png';
  if(m.includes('webp')) return 'webp';
  if(m.includes('gif')) return 'gif';
  return '';
}
async function downloadById(id, mimeHint){
  try{
    const url = api(`/api/images/${id}/download`);
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('download failed');
    const blob = await resp.blob();
    const ext = mimeToExt(mimeHint) || mimeToExt(resp.headers.get('Content-Type')) || 'bin';
    const name = `asset-${id}.${ext}`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }catch(e){ alert('Download failed.'); }
}

function card(item){
  const id   = item.image_id ?? item.id;
  const mime = item.mime || '';
  return `<div class="card" onclick="location.href='/image/${id}'">
    <div style="overflow:hidden;">
      <img class="thumb"
           src="${api(`/api/images/${id}/thumb`)}"
           onerror="this.onerror=null;this.src='${api(`/api/images/${id}/view`)}'"
           loading="lazy" alt="img-${id}">
    </div>
    <div class="body">
      <div class="meta"><span>ID: ${id.toString().padStart(4,'0')}</span>${scoreBadge(item.score)}</div>
      <div class="links">
        <a onclick="event.stopPropagation(); downloadById(${id}, '${mime}')">[DL]</a>
        <a onclick="event.stopPropagation(); location.href='/image/${id}'">[SIM]</a>
        <a class="danger" onclick="event.stopPropagation(); deleteImage(${id});return false;">[DEL]</a>
      </div>
    </div>
  </div>`;
}

// Global State
let globalList = [];
let currentList = [];
let sortOrder = 'desc';

function refreshGrid() {
  if(!globalList || !globalList.length){
    out.innerHTML = `<div style="text-align:center; padding:60px; color:var(--border-dim); font-family:var(--font-mono)">// NO SIGNAL DETECTED //<br><small>INITIATE UPLOAD OR SEARCH</small></div>`;
    return;
  }

  globalList.sort((a,b)=>{
    const ida = (a.image_id ?? a.id);
    const idb = (b.image_id ?? b.id);
    return sortOrder === 'asc' ? ida - idb : idb - ida;
  });

  currentList = globalList.slice(0, 8);
  out.innerHTML = currentList.map(card).join('');
}

function render(list){
  globalList = list || [];
  refreshGrid();
}

function renderSingle(detail){
  globalList = [{ image_id: detail.id, score: 1.0, mime: detail.mime }];
  refreshGrid();
}

async function deleteImage(id){
  if(!confirm(`PURGE ASSET #${id} FROM DATABASE?`)) return;
  try{
    const r = await fetch(api(`/api/images/${id}`), { method:'DELETE' });
    const j = await r.json();
    if(!r.ok || j.ok !== true) throw new Error(j.error || 'Delete failed');

    globalList = globalList.filter(x => (x.image_id ?? x.id) !== id);
    refreshGrid();
    showToast(`ASSET #${id} PURGED`);
  }catch(e){ alert('Failed to delete: ' + e.message); }
}

// 1. 面板切换 Tab 绑定
document.querySelectorAll('.tab[data-target]').forEach(t => {
    t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(t.dataset.target).classList.add('active');
    };
});

// 2. 排序 Tab 绑定
document.getElementById('sortAsc').onclick = function() {
    sortOrder = 'asc';
    this.classList.add('active');
    document.getElementById('sortDesc').classList.remove('active');
    refreshGrid();
};
document.getElementById('sortDesc').onclick = function() {
    sortOrder = 'desc';
    this.classList.add('active');
    document.getElementById('sortAsc').classList.remove('active');
    refreshGrid();
};

// 3. 链接 Tab 绑定
document.getElementById('tab-browse').onclick = function() {
    location.href = '/gallery';
};

let selectedFiles=[];
function bytes(n){ if(!n) return '0 B'; const u=['B','KB','MB','GB']; let i=0; while(n>=1024 && i<u.length-1){ n/=1024; i++; } return `${n.toFixed(i?1:0)} ${u[i]}`; }
function renderPre(){
  const box=$('#pre'), grid=$('#pgrid'), info=$('#preInfo'), btn=$('#btnUpload');
  if(!selectedFiles.length){ btn.disabled=true; info.textContent='BUFFER: EMPTY'; grid.innerHTML=''; return; }
  btn.disabled=false;
  const total=selectedFiles.reduce((a,f)=>a+(f.size||0),0);
  info.textContent=`BUFFER: ${selectedFiles.length} ITEMS / ${bytes(total)}`;
  grid.innerHTML='';
  selectedFiles.forEach((f,idx)=>{
    const url=URL.createObjectURL(f);
    grid.insertAdjacentHTML('beforeend', `<div class="thumbbox"><img src="${url}" alt="${f.name}" style="width:100%;height:100%;object-fit:cover;filter:grayscale(100%)"/><button class="rm" onclick="removePre(${idx})" style="position:absolute;top:0;right:0;background:red;color:white;border:none;width:15px;height:15px;font-size:10px;line-height:1;cursor:pointer;">X</button></div>`);
  });
}
window.removePre = (idx)=>{ selectedFiles.splice(idx,1); renderPre(); };
$('#btnClear').onclick=()=>{ selectedFiles=[]; renderPre(); };

const drop=$('#drop');
drop.addEventListener('dragover',e=>{e.preventDefault(); drop.style.borderColor='var(--neon-cyan)';});
drop.addEventListener('dragleave',()=>drop.style.borderColor='var(--border-dim)');
drop.addEventListener('drop',e=>{
  e.preventDefault(); drop.style.borderColor='var(--border-dim)';
  const fs=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
  if(!fs.length) return;
  selectedFiles=selectedFiles.concat(fs);
  renderPre();
});
$('#files').addEventListener('change',e=>{
  const fs=[...e.target.files].filter(f=>f.type.startsWith('image/'));
  selectedFiles=fs; renderPre();
});

$('#btnUpload').onclick = ()=>{ if(!selectedFiles.length) return alert('Choose file(s)'); uploadWithProgress(selectedFiles); };

async function uploadWithProgress(files){
  const prog=$('#prog'), list=$('#progList'), overallBar=$('#overallBar'), overallPct=$('#overallPct');
  list.innerHTML=''; overallBar.style.width='0%'; overallPct.textContent='0%'; prog.classList.add('show');

  const rows=files.map((f,i)=>{
      const id=`p${i}`;
      list.insertAdjacentHTML('beforeend', `<div class="rowi" style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${f.name}</span><span id="${id}-txt">0%</span></div>`);
      return {file:f, txt:document.getElementById(id+'-txt')};
  });

  const perFilePct=new Array(rows.length).fill(0);
  const setOverall=()=>{ const avg = rows.length? (perFilePct.reduce((a,b)=>a+b,0)/rows.length):0; overallBar.style.width=`${avg}%`; overallPct.textContent=`${Math.round(avg)}%`; };

  const results=[];
  for(let i=0;i<rows.length;i++){
    const r=rows[i]; const fd=new FormData(); fd.append('file', r.file);
    await new Promise((resolve)=>{
      const xhr=new XMLHttpRequest(); xhr.open('POST', api('/api/upload'));
      xhr.upload.onprogress=(e)=>{
        if(e.lengthComputable){
          const pct=Math.min(99, Math.floor((e.loaded/e.total)*100));
          perFilePct[i]=pct; r.txt.textContent=pct+'%';
          setOverall();
        }
      };
      xhr.onreadystatechange=()=>{
        if(xhr.readyState===4){
          try{ results.push(JSON.parse(xhr.responseText||'{}')); }catch(_){}
          perFilePct[i]=100; r.txt.textContent='OK'; setOverall(); resolve();
        }
      };
      xhr.send(fd);
    });
  }
  prog.classList.remove('show');

  const saved = results.flatMap(x=>x.saved||[]);
  const ok = saved.filter(x=>x && x.image_id);
  render(ok.map(x=>({image_id:x.image_id})));
  showToast('SEQUENCE_COMPLETE');

  openModal('TRANSFER COMPLETE', `${ok.length} ASSETS INDEXED.`);
  selectedFiles=[]; renderPre();
}

$('#btnQText').onclick = async ()=>{
  const q=$('#qText').value.trim(); if(!q) return;
  showToast('SEARCHING...');
  try {
    const r=await fetch(api(`/api/search?q=${encodeURIComponent(q)}&k=24`));
    render((await r.json()).results);
  } catch(e) { alert('Search Error'); }
};
$('#btnQImg').onclick = async ()=>{
  const f=$('#qImg').files[0]; if(!f) return alert('Choose reference image');
  showToast('ANALYZING PATTERN...');
  const fd=new FormData(); fd.append('file',f);
  const r=await fetch(api('/api/search_by_image'), {method:'POST', body:fd});
  render((await r.json()).results);
};
$('#btnQOCR').onclick = async ()=>{
  const q=$('#qOCR').value.trim(); if(!q) return;
  showToast('SCANNING INDEX...');
  const r=await fetch(api(`/api/search_ocr?q=${encodeURIComponent(q)}`));
  render((await r.json()).results);
};

async function findByIdExact(id){
  try{
    const r = await fetch(api(`/api/images/${id}`));
    if(!r.ok){ out.innerHTML = `<div style="text-align:center;padding:20px;color:red">ID #${id} NOT FOUND</div>`; return; }
    const detail = await r.json();
    renderSingle(detail);
  }catch(e){ out.innerHTML = `<div class="hint">ERROR: ${e}</div>`; }
}
document.getElementById('btnFindId').onclick = ()=>{
  const id = parseInt(document.getElementById('qId').value, 10);
  if(!id){ out.innerHTML = `<div class="hint">INPUT INT REQUIRED</div>`; return; }
  findByIdExact(id);
};

async function fetchImages(){
  const r = await fetch(api(`/api/images?order=${sortOrder}&limit=50`));
  const j = await r.json();
  render(j.items || j);
}
document.getElementById('btnBrowse').onclick = fetchImages;
document.getElementById('btnViewMore').addEventListener('click', () => { location.href = '../../frontend/gallery.html'; });
window.addEventListener('load', async ()=>{ try{ await fetchImages(); }catch(e){} });
</script>
</body>
</html>