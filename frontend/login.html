<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sign in / Register · Image Drive</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: #0f172a;
      --panel-2: #0d1526;
      --text: #e5e7eb;
      --muted: #97a3b6;
      --accent: #60a5fa;
      --accent-2: #38bdf8;
      --border: #1f2937;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius-lg: 14px;
      --radius-md: 12px;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #e2e8f0;
      background: radial-gradient(
          circle at 20% 10%,
          rgba(56, 189, 248, 0.08) 0%,
          transparent 50%
        ),
        radial-gradient(
          circle at 90% 30%,
          rgba(56, 189, 248, 0.1) 0%,
          transparent 55%
        ),
        linear-gradient(180deg, #0f172a 0%, #0a0f1e 100%);
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }

    .wrap{
      max-width: 880px;
      margin: 64px auto;
      padding: 0 22px;
    }

    .title{
      display:flex; align-items:center; gap:12px;
      font-weight:800; letter-spacing:.5px; margin:0 0 18px; line-height:1.2;
    }
    .title .dot{
      width:22px; height:22px; border-radius:50%;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow:0 0 16px rgba(56,189,248,.45);
    }
    .subtitle{ color:var(--muted); margin:4px 0 22px; font-size:14px; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)) , var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 22px;
    }

    .tabs{ display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .tabs button{
      background:transparent; color:var(--muted); border:0; padding:10px 16px; cursor:pointer;
    }
    .tabs button.active{
      color:#0b1220; background:linear-gradient(135deg, var(--accent), var(--accent-2));
      font-weight:700;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:16px; }
    label{ font-weight:700; color:var(--text); margin-top:6px; }
    .input{
      width:100%; padding:13px 14px;
      background: #0b1324; color:var(--text);
      border:1px solid #1b2435; border-radius:12px; outline:none;
      transition: border .15s, box-shadow .15s;
    }
    .input::placeholder{ color:#6b7280; }
    .input:focus{
      border-color: #2a3a5c;
      box-shadow: 0 0 0 3px rgba(96,165,250,.22);
    }

    .primary{
      margin-top:10px; width:100%; padding:12px 16px;
      border-radius:12px; border:1px solid transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#0b1220; font-weight:800; cursor:pointer;
      box-shadow:0 6px 18px rgba(56,189,248,.25);
    }
    .primary:hover{ filter:brightness(1.05); }
    .primary[disabled]{ opacity:.65; cursor:not-allowed; }

    .actions{
      display:flex; gap:10px; margin-top:10px;
    }
    .btn{
      flex:1; padding:10px 12px; border-radius:10px; cursor:pointer;
      color:var(--text); background: var(--panel-2); border:1px solid #1b2435;
    }
    .btn:hover{ border-color:#2a3a5c; }

    .msg{ margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid #1b2435; display:none; }
    .msg.ok{ display:block; border-color:#10b981; background:rgba(16,185,129,.12); }
    .msg.err{ display:block; border-color:#ef4444; background:rgba(239,68,68,.12); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title"><span class="dot"></span>Image Drive · Login</h1>
    <div class="subtitle">Sign in or register to use Image Drive · Studio</div>

    <div class="card">
      <div class="tabs" role="tablist">
        <button id="tabLogin" class="active" aria-selected="true">Sign in</button>
        <button id="tabRegister" aria-selected="false">Register</button>
      </div>

      <div class="grid">
        <div>
          <label for="email">Email</label>
          <input id="email" class="input" type="email"
                 placeholder="name@example.com" autocomplete="username" />
        </div>
        <div>
          <label for="password">Password</label>
          <input id="password" class="input" type="password"
                 placeholder="••••••••" autocomplete="current-password" />
        </div>

        <button id="btnPrimary" class="primary">Sign in</button>

        <div class="actions">
          <button id="btnRefresh" class="btn">Refresh Access</button>
          <button id="btnCheck" class="btn">Check Status</button>
          <button id="btnLogout" class="btn">Sign out</button>
        </div>

        <div id="msg" class="msg"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const AUTH_BASE = "/api/auth";
    let mode = "login";

    function showMsg(ok, text){
      const box = $("msg");
      box.textContent = text || "";
      box.className = "msg " + (ok ? "ok" : "err");
    }

    $("tabLogin").onclick = () => {
      mode = "login";
      $("tabLogin").classList.add("active");
      $("tabRegister").classList.remove("active");
      $("btnPrimary").textContent = "Sign in";
      showMsg(false, "");
    };

    $("tabRegister").onclick = () => {
      mode = "register";
      $("tabRegister").classList.add("active");
      $("tabLogin").classList.remove("active");
      $("btnPrimary").textContent = "Register & sign in";
      showMsg(false, "");
    };

    async function postJson(url, data){
      const r = await fetch(url, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data||{})
      });
      let j={};try{j=await r.json();}catch(e){}
      return {ok:r.ok,status:r.status,json:j};
    }

    $("btnPrimary").onclick = doPrimary;
    $("password").addEventListener("keydown", e=>{
      if(e.key==="Enter") doPrimary();
    });

    async function doPrimary(){
      const email = $("email").value.trim();
      const password = $("password").value;
      if(!email || !password){
        showMsg(false, "Please enter both email and password.");
        return;
      }
      const btn = $("btnPrimary");
      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = "Processing…";

      try{
        if(mode === "register"){
          const reg = await postJson(`${AUTH_BASE}/register`, {email,password});
          if(!(reg.ok && reg.json && reg.json.ok)){
            showMsg(false, reg.json.error || `Registration failed (HTTP ${reg.status})`);
            btn.disabled = false; btn.textContent = prev;
            return;
          }
        }
        const res = await postJson(`${AUTH_BASE}/login`, {email,password});
        if(res.ok && res.json && res.json.ok){
          localStorage.setItem("access_token",  res.json.access_token || "");
          localStorage.setItem("refresh_token", res.json.refresh_token || "");
          showMsg(true, "Signed in, redirecting to Studio …");
          setTimeout(()=> window.location.href="/", 700);
        }else{
          showMsg(false, res.json.error || `Sign-in failed (HTTP ${res.status})`);
        }
      }catch(e){
        showMsg(false, "Network error: "+e);
      }finally{
        btn.disabled = false;
        btn.textContent = prev;
      }
    }

    $("btnRefresh").onclick = async ()=>{
      const refresh = localStorage.getItem("refresh_token");
      if(!refresh){
        showMsg(false,"Not signed in.");
        return;
      }
      const r = await fetch(`${AUTH_BASE}/refresh`,{
        method:"POST",
        headers:{Authorization:"Bearer "+refresh}
      });
      let j={};try{j=await r.json();}catch(e){}
      if(r.ok && j.ok && j.access_token){
        localStorage.setItem("access_token", j.access_token);
        showMsg(true,"Access token refreshed.");
      }else{
        showMsg(false, j.error || `Refresh failed (HTTP ${r.status})`);
      }
    };

    $("btnCheck").onclick = async ()=>{
      const access = localStorage.getItem("access_token");
      if(!access){
        showMsg(false,"Not signed in.");
        return;
      }
      const r = await fetch(`${AUTH_BASE}/me`,{
        headers:{Authorization:"Bearer "+access}
      });
      if(r.ok){
        const j = await r.json().catch(()=>({}));
        const who = (j.user && j.user.email) || j.email || j.id || "unknown";
        showMsg(true,"Signed in as: "+who);
      }else if(r.status===401){
        showMsg(false,"Unauthorized or token expired.");
      }else{
        showMsg(false,"Status check failed (HTTP "+r.status+")");
      }
    };

    $("btnLogout").onclick = async ()=>{
      const access = localStorage.getItem("access_token");
      try{
        if(access){
          await fetch(`${AUTH_BASE}/logout`,{
            method:"POST",
            headers:{Authorization:"Bearer "+access}
          });
        }
      }catch(e){}
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      showMsg(true,"Signed out.");
    };
  </script>
</body>
</html>
