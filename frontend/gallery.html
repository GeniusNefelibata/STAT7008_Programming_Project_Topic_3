<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEURAL DRIVE // GALLERY</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;600;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    /* Inherited Cyberpunk Theme */
    :root {
      --bg-core: #050505; --bg-panel: rgba(10, 15, 20, 0.7);
      --neon-cyan: #00f3ff; --neon-magenta: #ff0055; --neon-yellow: #fcee0a;
      --grid-color: rgba(0, 243, 255, 0.07); --border-dim: rgba(0, 243, 255, 0.15);
      --text-main: #e0f7fa; --text-muted: #617d8a;
      --font-hud: 'Rajdhani', sans-serif; --font-mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; outline: none; }
    html, body { height: 100%; margin: 0; overflow: hidden; }

    body {
      background-color: var(--bg-core); color: var(--text-main); font-family: var(--font-hud);
      background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px), radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.1) 0%, transparent 60%);
      background-size: 40px 40px, 40px 40px, 100% 100%;
    }

    header {
      position: sticky; top: 0; z-index: 100; background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-dim); height: 70px; display: flex; align-items: center;
    }
    .bar { width: 100%; max-width: 1600px; margin: 0 auto; padding: 0 32px; display: flex; justify-content: space-between; align-items: center; }
    .brand { display: flex; gap: 16px; align-items: center; font-weight: 700; font-size: 24px; letter-spacing: 2px; color: #fff; cursor: pointer; }
    .logo { width: 40px; height: 40px; background: var(--neon-cyan); color: #000; display: grid; place-items: center; font-size: 22px; clip-path: polygon(20% 0%, 100% 0, 100% 80%, 80% 100%, 0 100%, 0% 20%); animation: flicker 4s infinite; }
    @keyframes flicker { 0%, 19.9%, 62.9%, 64.9%, 100% { opacity: 1; } 20%, 63% { opacity: 0.5; } }
    .nav-btn { font-family: var(--font-mono); font-size: 12px; color: var(--neon-cyan); text-decoration: none; border: 1px solid var(--border-dim); padding: 8px 20px; }
    .nav-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

    .container { max-width: 1600px; margin: 0 auto; padding: 20px 32px; height: calc(100vh - 70px); }
    .layout { display: grid; grid-template-columns: 300px 1fr 380px; gap: 24px; height: 100%; }

    .panel { background: var(--bg-panel); border: 1px solid var(--border-dim); clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%); padding: 24px; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
    .panel::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--neon-cyan); }

    h3 { font-family: var(--font-mono); color: var(--neon-cyan); font-size: 16px; margin: 0 0 20px 0; border-bottom: 1px solid var(--border-dim); padding-bottom: 10px; }

    select, input { width: 100%; background: #000; border: 1px solid var(--border-dim); color: var(--neon-cyan); padding: 10px; font-family: var(--font-mono); margin-bottom: 20px; }
    .btn { background: transparent; border: 1px solid var(--border-dim); color: var(--neon-cyan); padding: 10px 20px; font-family: var(--font-hud); font-weight: 700; cursor: pointer; flex: 1; }
    .btn:hover { background: var(--neon-cyan); color: #000; }
    .btn-row { display: flex; gap: 10px; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 20px; overflow-y: auto; flex: 1; padding-right: 10px; }
    .thumb-card { background: #0e1015; border: 1px solid var(--border-dim); position: relative; cursor: pointer; transition: all 0.3s; }
    .thumb-card:hover { transform: translateY(-5px); border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }
    .thumb-card.active { border-color: var(--neon-magenta); box-shadow: 0 0 15px rgba(255, 0, 85, 0.3); } /* 选中状态 */
    .thumb-card img { width: 100%; aspect-ratio: 1; object-fit: cover; filter: grayscale(40%); }
    .thumb-card:hover img, .thumb-card.active img { filter: grayscale(0%); }
    .thumb-meta { padding: 10px; font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); display: flex; justify-content: space-between; }
    .link-btn { color: var(--neon-cyan); cursor: pointer; text-decoration: none; font-weight: bold; position: relative; z-index: 10; }

    .grid-sim { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; overflow-y: auto; flex: 1; }
    .sim-item { border: 1px solid var(--border-dim); cursor: pointer; text-decoration: none; color: inherit; display: block; }
    .sim-item:hover { border-color: var(--neon-cyan); }
    .sim-item img { width: 100%; height: 100px; object-fit: cover; }
    .sim-item small { padding: 5px; display: block; font-size: 10px; font-family: var(--font-mono); color: var(--text-muted); }

    .footerbar { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-dim); display: flex; justify-content: space-between; align-items: center; font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: var(--border-dim); }
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand" onclick="location.href='http://127.0.0.1:5000/'">
      <div class="logo">G</div>
      <div>NEURAL DRIVE <small style="font-size: 10px; color:var(--neon-magenta);">// GALLERY</small></div>
    </div>
    <a class="nav-btn" href="http://127.0.0.1:5000/">← BACK TO STUDIO</a>
  </div>
</header>

<div class="container">
  <div class="layout">
    <!-- Left: Filters -->
    <aside class="panel">
      <h3>FILTERS</h3>
      <label style="font-family:var(--font-mono); font-size:10px; color:var(--text-muted)">CATEGORY</label>
      <select id="f_category"><option value="">ALL ASSETS</option></select>

      <label style="font-family:var(--font-mono); font-size:10px; color:var(--text-muted)">SORT</label>
      <select id="f_order">
        <option value="desc">NEWEST (ID ↓)</option>
        <option value="asc">OLDEST (ID ↑)</option>
      </select>

      <div class="btn-row">
        <button class="btn" id="btnApply">APPLY</button>
        <button class="btn" id="btnReset" style="border-color:var(--neon-magenta); color:var(--neon-magenta)">RESET</button>
      </div>
    </aside>

    <!-- Middle: Grid -->
    <main class="panel">
      <h3>DATA GRID</h3>
      <div id="grid" class="grid"></div>
      <div class="footerbar">
        <div class="btn-row" style="gap:5px">
            <button class="btn" id="btnPrev" style="padding:5px 10px"><</button>
            <button class="btn" id="btnNext" style="padding:5px 10px">></button>
        </div>
        <div id="pageInfo">PAGE 1 / 1</div>
      </div>
    </main>

    <!-- Right: Relational Data (Similar Images) -->
    <aside class="panel side" id="simPanel">
      <h3>RELATIONAL DATA</h3>
      <!-- 种子图片信息区域 -->
      <div id="seedInfoBlock" style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid var(--border-dim); display:none">
        <div id="seedMeta" style="font-family:var(--font-mono); font-size:12px; color:var(--text-muted); margin-bottom:10px">
          SELECTED: <span style="color:var(--neon-cyan)">#ID</span>
        </div>
        <div style="display:flex; gap:10px">
          <!-- 这个按钮用于跳转详情页 -->
          <button class="btn" id="btnSeedOpen" style="font-size:10px; padding:8px">OPEN DETAIL</button>
          <button class="btn" id="btnSeedDL" style="font-size:10px; padding:8px">DOWNLOAD</button>
        </div>
      </div>

      <!-- 默认提示 -->
      <div id="seedPlaceholder" style="font-family:var(--font-mono); font-size:12px; color:var(--text-muted); text-align:center; padding:20px;">
        SELECT AN ASSET FROM GRID TO ANALYZE
      </div>

      <!-- 相似图片网格 -->
      <div id="simGrid" class="grid-sim"></div>
    </aside>
  </div>
</div>

<script>
const api = p => (p && p.startsWith('http')) ? p : `${location.origin}${p}`;

async function fetchImages(params={}){
  const q = new URLSearchParams(Object.assign({limit:24}, params));
  const r = await fetch(api('/api/images?' + q));
  return r.json();
}

let state = { page:1, limit:24, order:'desc', category:'' };
let currentSeedId = null;

async function downloadById(id, mimeHint){
  try{
    const url = api(`/api/images/${id}/download`);
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('download failed');
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `asset-${id}`;
    a.click();
  }catch(e){ alert('Download failed.'); }
}

// 生成图片卡片
function imgCard(it){
  const div = document.createElement('div');
  div.className = 'thumb-card';
  div.id = `card-${it.id}`; // 用于高亮选中
  div.innerHTML = `
    <img src="${api(`/api/images/${it.id}/thumb`)}" onerror="this.src='${api(`/api/images/${it.id}/view`)}'">
    <div class="thumb-meta">
      <span>ID:${it.id}</span>
      <a class="link-btn" data-dl>[DL]</a>
    </div>`;

  // 点击卡片 -> 触发 showSimilar（更新右侧），不跳转
  div.onclick = () => showSimilar(it);

  // 下载按钮 -> 独立下载
  div.querySelector('[data-dl]').onclick = (e) => {
      e.stopPropagation();
      downloadById(it.id, it.mime);
  };
  return div;
}

async function load(){
  const data = await fetchImages({ ...state, offset: (state.page-1)*state.limit });
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  (data.items||[]).forEach(it => grid.appendChild(imgCard(it)));
  document.getElementById('pageInfo').textContent = `PAGE ${state.page}`;

  // 如果当前有选中的 seed，尝试高亮它
  if(currentSeedId) {
      const card = document.getElementById(`card-${currentSeedId}`);
      if(card) card.classList.add('active');
  } else if(data.items && data.items.length > 0) {
      // 默认选中第一个，方便展示
      showSimilar(data.items[0]);
  }
}

// 更新右侧面板逻辑
async function showSimilar(seed){
  currentSeedId = seed.id;

  // 高亮处理
  document.querySelectorAll('.thumb-card').forEach(el => el.classList.remove('active'));
  const activeCard = document.getElementById(`card-${seed.id}`);
  if(activeCard) activeCard.classList.add('active');

  // 更新 UI 显示
  document.getElementById('seedPlaceholder').style.display = 'none';
  document.getElementById('seedInfoBlock').style.display = 'block';

  document.getElementById('seedMeta').innerHTML = `SELECTED: <span style="color:var(--neon-cyan)">#${seed.id}</span><br>TYPE: ${seed.mime || 'N/A'}`;

  // 绑定右侧按钮事件
  document.getElementById('btnSeedOpen').onclick = () => location.href = `/image/${seed.id}`;
  document.getElementById('btnSeedDL').onclick = () => downloadById(seed.id, seed.mime);

  // 加载相似图
  const simGrid = document.getElementById('simGrid');
  simGrid.innerHTML = '<div style="padding:10px;color:var(--text-muted);font-family:var(--font-mono)">SCANNING...</div>';

  try {
    const r = await fetch(api(`/api/images/${seed.id}/similar?k=10`));
    const list = await r.json();
    simGrid.innerHTML = '';

    const items = list.items || list.results || list;
    if(!items.length){
        simGrid.innerHTML = '<div style="padding:10px;color:var(--text-muted);font-family:var(--font-mono)">NO MATCHES FOUND</div>';
        return;
    }

    items.forEach(it => {
      const id = it.id??it.image_id;
      const a = document.createElement('a');
      a.className = 'sim-item';
      // 相似图片点击 -> 跳转到该图的详情页
      a.href = `image/${id}`;
      a.innerHTML = `<img src="${api(`/api/images/${id}/thumb`)}"><div style="padding:5px;display:flex;justify-content:space-between"><small>#${id}</small><small style="color:var(--neon-cyan)">${Math.round((it.score||0)*100)}%</small></div>`;
      simGrid.appendChild(a);
    });
  } catch(e) {
    simGrid.innerHTML = '<div style="padding:10px;color:var(--neon-magenta)">ERROR</div>';
  }
}

// 初始化分类过滤器
(async function boot(){
  try {
    const r = await fetch(api('/api/analytics/category_breakdown'));
    if(r.ok) {
        const data = await r.json();
        const sel = document.getElementById('f_category');
        (Array.isArray(data) ? data : data.items).forEach(c => {
             const opt = document.createElement('option');
             opt.value = c.category; opt.textContent = c.category.toUpperCase();
             sel.appendChild(opt);
        });
    }
  } catch(e) {}
  load();
})();

document.getElementById('btnApply').onclick = () => {
    state.category = document.getElementById('f_category').value;
    state.order = document.getElementById('f_order').value;
    state.page = 1;
    load();
};
document.getElementById('btnReset').onclick = () => {
    document.getElementById('f_category').value = '';
    document.getElementById('f_order').value = 'desc';
    state = { page:1, limit:24, order:'desc', category:'' };
    load();
};
document.getElementById('btnPrev').onclick = () => { if(state.page>1) { state.page--; load(); }};
document.getElementById('btnNext').onclick = () => { state.page++; load(); };
</script>
</body>
</html>