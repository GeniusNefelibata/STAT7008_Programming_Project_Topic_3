<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Image Drive Â· Gallery</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --border:#1f2a3a; --fg:#e6edf3; --muted:#99a7b4; --accent:#6aa9ff;
    --radius:16px; --w:1400px;
  }
  *{box-sizing:border-box}
  html, body{height:100%; margin:0; color:var(--fg); background:var(--bg); font-family:system-ui, -apple-system, Segoe UI, "Microsoft Yahei", sans-serif}
  header{position:sticky; top:0; z-index:5; padding:12px 18px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(10,14,20,.92), rgba(10,14,20,.7)); backdrop-filter:blur(8px);}
  .row{display:flex; align-items:center; gap:12px}
  .brand{font-weight:700}
  a.link{color:var(--accent); text-decoration:none}

  .container{max-width:var(--w); margin:16px auto; padding:0 18px}
  /* ä¸‰æ ï¼šå·¦-ç­›é€‰ï¼›ä¸­-ç½‘æ ¼ï¼›å³-ç›¸ä¼¼ */
  .layout{
    display:grid;
    grid-template-columns: 280px 1fr 360px;
    gap:16px;
    min-height: calc(100vh - 84px)
  }
  @media (max-width:1280px){ .layout{grid-template-columns:280px 1fr} .side{display:none} }
  @media (max-width:980px){ .layout{grid-template-columns:1fr} }

  .panel{border:1px solid var(--border); border-radius:14px; background:linear-gradient(180deg,#0f1520,#0b1119); padding:14px}
  .panel h3{margin:0 0 8px}
  .muted{color:var(--muted); font-size:12px}

  .filter-group{margin-bottom:14px}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  select, input[type="number"]{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid #2a3f5a;
    background:#0b1119; color:var(--fg);
  }
  .btn{padding:9px 12px; border-radius:10px; border:1px solid #2a3f5a; background:linear-gradient(180deg,#18314c,#142a40); color:var(--fg); cursor:pointer}
  .btn:hover{filter:brightness(1.07)}
  .btn-row{display:flex; gap:8px; flex-wrap:wrap}

  .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:12px}
  .thumb-card{border:1px solid var(--border); border-radius:12px; background:#0b1119; overflow:hidden}
  .thumb-card img{width:100%; aspect-ratio:4/3; object-fit:cover; display:block; cursor:pointer}
  .thumb-meta{padding:8px 10px; display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted)}
  .thumb-meta .right a{margin-left:8px}

  .footerbar{display:flex; align-items:center; gap:10px; justify-content:flex-start; margin-top:12px}
  .footerbar .info{color:var(--muted); font-size:12px}
  .jump{display:flex; align-items:center; gap:6px}

  /* å³ä¾§ Similar é¢æ¿ï¼ˆå¸é¡¶ã€ç‹¬ç«‹æ»šåŠ¨ï¼‰ */
  .side{position:sticky; top:86px; align-self:start; max-height: calc(100vh - 110px); overflow:auto}
  .side .head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
  .seed-meta{font-size:13px; color:var(--muted)}
  .seed-actions{display:flex; gap:8px}
  .grid-sim{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px}
  .sim-item{display:block; border:1px solid var(--border); border-radius:10px; overflow:hidden; text-decoration:none; color:inherit; background:#0f1520}
  .sim-item img{width:100%; height:110px; object-fit:cover; display:block}
  .sim-item small{display:block; padding:6px 8px; color:var(--muted)}
  .score{float:right}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <div class="row"><div class="brand">ğŸ“š Gallery</div></div>
    <a class="link" href="/">â† Back to Studio</a>
  </div>
</header>

<div class="container">
  <div class="layout">
    <!-- Left: Filters -->
    <aside class="panel">
      <h3>Filters</h3>
      <div class="filter-group">
        <label>Category</label>
        <select id="f_category">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Order by ID</label>
        <select id="f_order">
          <option value="desc">Newest first (ID â†“)</option>
          <option value="asc">Oldest first (ID â†‘)</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Items per page</label>
        <select id="f_limit">
          <option>24</option><option>48</option><option>96</option>
        </select>
      </div>
      <div class="btn-row">
        <button class="btn" id="btnApply">Apply</button>
        <button class="btn" id="btnReset">Reset</button>
      </div>
      <div class="muted" style="margin-top:10px">
        Tip: Click an image to view similar results on the right; use â€œdownloadâ€ to save the original file.
      </div>
    </aside>

    <!-- Middle: Grid + Pagination -->
    <main class="panel">
      <h3>Results</h3>
      <div id="grid" class="grid"></div>

      <div class="footerbar">
        <button class="btn" id="btnPrev">Prev</button>
        <button class="btn" id="btnNext">Next</button>
        <div class="info" id="pageInfo">Page 1 of 1</div>

        <div class="jump">
          <span class="muted">Jump to</span>
          <input id="jumpTo" type="number" min="1" value="1" style="width:70px; padding:6px 8px; border-radius:8px; border:1px solid #2a3f5a; background:#0b1119; color:#e6edf3">
          <button class="btn" id="btnGo">Go</button>
        </div>
      </div>
    </main>

    <!-- Right: Similar -->
    <aside class="panel side" id="simPanel">
      <div class="head">
        <div>
          <h3 style="margin:0 0 4px">Similar</h3>
          <div class="seed-meta" id="seedMeta">Pick an image to view similar results â†’</div>
        </div>
        <div class="seed-actions" id="seedActions" style="display:none">
          <button class="btn" id="btnSeedOpen">Open</button>
          <button class="btn" id="btnSeedDL">Download</button>
        </div>
      </div>
      <div id="simGrid" class="grid-sim"></div>
    </aside>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const api = p => (p && p.startsWith('http')) ? p : `${location.origin}${p}`;

function mimeToExt(mime){
  if(!mime) return '';
  const m = String(mime).toLowerCase();
  if(m.includes('jpeg') || m.includes('jpg')) return 'jpg';
  if(m.includes('png')) return 'png';
  if(m.includes('webp')) return 'webp';
  if(m.includes('gif')) return 'gif';
  if(m.includes('bmp')) return 'bmp';
  if(m.includes('tiff')) return 'tif';
  return 'bin';
}

async function downloadById(id, mimeHint){
  try{
    const url = api(`/api/images/${id}/download`);
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('download failed');
    const blob = await resp.blob();
    const ext = mimeToExt(mimeHint || resp.headers.get('Content-Type'));
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${id}.${ext}`;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }catch(e){
    alert('Download failed.');
  }
}

async function fetchCategories(){
  try{
    const r = await fetch(api('/api/analytics/category_breakdown'));
    if(!r.ok) return [];
    const data = await r.json();
    const rows = Array.isArray(data) ? data : (data.items || []);
    return rows
      .map(x => ({ c: (x.category || '').trim(), n: x.count || 0 }))
      .filter(x => x.c && x.c !== 'uncategorized' && x.n > 0)
      .sort((a,b)=> a.c.localeCompare(b.c))
      .map(x => x.c);
  }catch(_){ return []; }
}

async function fetchImages({category='', order='desc', limit=24, page=1}={}){
  const offset = Math.max(0, (page-1)*limit);
  const q = new URLSearchParams({ order, limit, offset });
  if (category) q.set('category', category);
  const r = await fetch(api('/api/images?' + q.toString()));
  if(!r.ok) throw new Error('list images failed');
  return r.json(); // { items:[...], total:N }
}

/* ---------- state ---------- */
let state = { category:'', order:'desc', limit:24, page:1, total:0, totalPages:1 };
let currentItems = []; // å½“å‰é¡µ items
let currentSeed = null; // å³ä¾§ seed è¯¦æƒ…ï¼ˆ{id, mime, category...}ï¼‰

/* ---------- UI builders ---------- */
function imgCard(it){
  const el = document.createElement('div');
  el.className = 'thumb-card';
  const thumbUrl = api(`/api/images/${it.id}/thumb`);
  el.innerHTML = `
    <img src="${thumbUrl}" alt="#${it.id}" title="Click to view similar">
    <div class="thumb-meta">
      <span>#${it.id} Â· ${(it.category||'â€”')}</span>
      <span class="right">
        <a href="javascript:void(0)" class="link" data-dl>download</a>
      </span>
    </div>`;
  // ç‚¹å‡»ç¼©ç•¥å›¾ -> å³ä¾§ Similar
  el.querySelector('img').onclick = () => showSimilar(it.id);
  // ä¸‹è½½æŒ‰é’®
  el.querySelector('[data-dl]').onclick = () => downloadById(it.id, it.mime);
  return el;
}

function updatePagerUI(){
  state.totalPages = Math.max(1, Math.ceil((state.total || 0) / state.limit));
  document.getElementById('pageInfo').textContent = `Page ${state.page} of ${state.totalPages}`;
  document.getElementById('jumpTo').value = state.page;
}

/* ---------- Similar panel ---------- */
async function showSimilar(imageId){
  // å– seed è¯¦æƒ…
  try{
    const r = await fetch(api(`/api/images/${imageId}`));
    if(!r.ok) throw new Error('seed not found');
    const seed = await r.json();
    currentSeed = seed;

    // é¡¶éƒ¨ seed æ–‡æ¡ˆ & æŒ‰é’®
    const meta = document.getElementById('seedMeta');
    meta.textContent = `Similar to #${seed.id} Â· ${(seed.category || 'â€”')}`;
    const acts = document.getElementById('seedActions');
    acts.style.display = 'flex';
    document.getElementById('btnSeedOpen').onclick = ()=> location.href = `/image/${seed.id}`;
    document.getElementById('btnSeedDL').onclick = ()=> downloadById(seed.id, seed.mime);

    // å–ç›¸ä¼¼
    const res = await fetch(api(`/api/images/${seed.id}/similar?k=24`));
    if(!res.ok){ renderSimilar([]); return; }
    const j = await res.json();
    const list = Array.isArray(j) ? j : (j.items || j.results || []);
    renderSimilar(list);
  }catch(e){
    currentSeed = null;
    document.getElementById('seedMeta').textContent = 'Pick an image to view similar results â†’';
    document.getElementById('seedActions').style.display = 'none';
    renderSimilar([]);
  }
}

function renderSimilar(list){
  const box = document.getElementById('simGrid');
  box.innerHTML = '';
  if(!list || !list.length){
    box.innerHTML = `<div class="muted">No similar images.</div>`;
    return;
  }
  // æ¸²æŸ“ç›¸ä¼¼å¡ç‰‡
  list.forEach(it=>{
    const iid = it.id ?? it.image_id ?? it.imageId;
    if(!iid) return;
    const score = (typeof it.score === 'number' ? it.score : (it.score01 ?? 0));
    const a = document.createElement('a'); a.className='sim-item'; a.href=`/image/${iid}`;
    const img = document.createElement('img');
    img.loading='lazy'; img.src = api(`/api/images/${iid}/thumb`);
    img.onerror = ()=>{ img.onerror = null; img.src = api(`/api/images/${iid}/view`); };
    const cap = document.createElement('small');
    cap.innerHTML = `#${iid} <span class="score">${Math.round((score||0)*100)}%</span>`;
    a.appendChild(img); a.appendChild(cap); box.appendChild(a);
  });
}

/* ---------- data load ---------- */
async function load(reset=false){
  if(reset){ state.page = 1; }
  const data = await fetchImages(state);
  const items = data.items || [];
  currentItems = items;
  state.total = Number.isFinite(data.total) ? data.total : (state.page-1)*state.limit + items.length;

  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  items.forEach(it => grid.appendChild(imgCard(it)));

  updatePagerUI();

  // å¦‚æœå³ä¾§è¿˜æ²¡ seedï¼Œé»˜è®¤æ˜¾ç¤ºå½“å‰é¡µç¬¬ä¸€å¼ çš„ç›¸ä¼¼ï¼Œæ–¹ä¾¿ä½“éªŒ
  if(!currentSeed && items.length){
    showSimilar(items[0].id);
  }
}

/* ---------- boot & events ---------- */
(async function boot(){
  // ç±»ç›®å¡«å……
  const cats = await fetchCategories();
  const sel = document.getElementById('f_category');
  cats.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    sel.appendChild(opt);
  });

  document.getElementById('btnApply').onclick = ()=> {
    state.category = document.getElementById('f_category').value;
    state.order    = document.getElementById('f_order').value;
    state.limit    = parseInt(document.getElementById('f_limit').value,10) || 24;
    currentSeed = null;
    load(true);
  };

  document.getElementById('btnReset').onclick = ()=> {
    document.getElementById('f_category').value = '';
    document.getElementById('f_order').value = 'desc';
    document.getElementById('f_limit').value = '24';
    state = { category:'', order:'desc', limit:24, page:1, total:0, totalPages:1 };
    currentSeed = null;
    load(true);
  };

  document.getElementById('btnPrev').onclick = ()=> {
    if (state.page > 1){ state.page -= 1; load(false); }
  };
  document.getElementById('btnNext').onclick = ()=> {
    if (state.page < state.totalPages){ state.page += 1; load(false); }
  };
  document.getElementById('btnGo').onclick = ()=> {
    const p = parseInt(document.getElementById('jumpTo').value, 10) || 1;
    state.page = Math.min(Math.max(1, p), state.totalPages);
    load(false);
  };

  // åˆæ¬¡åŠ è½½
  load(true);
})();
</script>
</body>
</html>
