<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Image Drive ¬∑ Gallery</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --border:#1f2a3a; --fg:#e6edf3; --muted:#99a7b4; --accent:#6aa9ff;
    --radius:16px; --w:1280px;
  }
  *{box-sizing:border-box}
  html, body{height:100%; margin:0; color:var(--fg); background:var(--bg); font-family:system-ui, -apple-system, Segoe UI, "Microsoft Yahei", sans-serif}
  header{position:sticky; top:0; z-index:5; padding:12px 18px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(10,14,20,.92), rgba(10,14,20,.7)); backdrop-filter:blur(8px);}
  .row{display:flex; align-items:center; gap:12px}
  .brand{font-weight:700}
  a.link{color:var(--accent); text-decoration:none}
  .container{max-width:var(--w); margin:16px auto; padding:0 18px}
  .layout{display:grid; grid-template-columns: 280px 1fr; gap:16px; min-height: calc(100vh - 84px)}
  @media (max-width:1100px){ .layout{grid-template-columns:1fr} }

  .panel{border:1px solid var(--border); border-radius:14px; background:linear-gradient(180deg,#0f1520,#0b1119); padding:14px}
  .panel h3{margin:0 0 8px}
  .muted{color:var(--muted); font-size:12px}

  .filter-group{margin-bottom:14px}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  select, input[type="number"]{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid #2a3f5a;
    background:#0b1119; color:var(--fg);
  }
  .btn{padding:9px 12px; border-radius:10px; border:1px solid #2a3f5a; background:linear-gradient(180deg,#18314c,#142a40); color:var(--fg); cursor:pointer}
  .btn:hover{filter:brightness(1.07)}
  .btn-row{display:flex; gap:8px; flex-wrap:wrap}

  .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:12px}
  .thumb-card{border:1px solid var(--border); border-radius:12px; background:#0b1119; overflow:hidden}
  .thumb-card img{width:100%; aspect-ratio:4/3; object-fit:cover; display:block; cursor:pointer}
  .thumb-meta{padding:8px 10px; display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted)}

  .footerbar{display:flex; align-items:center; gap:10px; justify-content:flex-start; margin-top:12px}
  .footerbar .info{color:var(--muted); font-size:12px}
  .jump{display:flex; align-items:center; gap:6px}

  /* Lightbox */
  .lightbox{position:fixed; inset:0; background:rgba(6,10,16,.72); backdrop-filter: blur(6px); display:none; align-items:center; justify-content:center; z-index:80}
  .lightbox.show{display:flex}
  .lb-inner{position:relative; max-width:92vw; max-height:86vh; background:linear-gradient(180deg,#0d121a,#0b0f14); border:1px solid var(--border); border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,.55); padding:16px}
  .lb-img{max-width:86vw; max-height:72vh; display:block; border-radius:12px}
  .lb-meta{display:flex; align-items:center; justify-content:space-between; margin-top:10px; color:var(--muted)}
  .lb-actions{position:absolute; inset:auto 14px 16px 14px; display:flex; justify-content:space-between; pointer-events:none}
  .lb-btn{pointer-events:auto; width:42px; height:42px; border-radius:999px; border:1px solid #2a3f5a; background:linear-gradient(180deg,#18314c,#142a40); color:var(--fg); display:grid; place-items:center; cursor:pointer; opacity:.92}
  .lb-btn:hover{filter:brightness(1.08)}
  .lb-close{position:absolute; top:10px; right:10px}
  .lb-hint{font-size:12px}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <div class="row"><div class="brand">üìö Gallery</div></div>
    <a class="link" href="/">‚Üê Back to Studio</a>
  </div>
</header>

<div class="container">
  <div class="layout">
    <!-- Left: Filters -->
    <aside class="panel">
      <h3>Filters</h3>
      <div class="filter-group">
        <label>Category</label>
        <select id="f_category">
          <option value="">All</option>
          <!-- options will be injected dynamically; no 'uncategorized' here -->
        </select>
      </div>
      <div class="filter-group">
        <label>Order by ID</label>
        <select id="f_order">
          <option value="desc">Newest first (ID ‚Üì)</option>
          <option value="asc">Oldest first (ID ‚Üë)</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Items per page</label>
        <select id="f_limit">
          <option>24</option><option>48</option><option>96</option>
        </select>
      </div>
      <div class="btn-row">
        <button class="btn" id="btnApply">Apply</button>
        <button class="btn" id="btnReset">Reset</button>
      </div>
      <div class="muted" style="margin-top:10px">Tip: Click image to preview. Use the button to download; ‚Äúsimilar‚Äù jumps to Studio.</div>
    </aside>

    <!-- Right: Grid + Pagination -->
    <main class="panel">
      <h3>Results</h3>
      <div id="grid" class="grid"></div>

      <div class="footerbar">
        <button class="btn" id="btnPrev">Prev</button>
        <button class="btn" id="btnNext">Next</button>
        <div class="info" id="pageInfo">Page 1 of 1</div>

        <div class="jump">
          <span class="muted">Jump to</span>
          <input id="jumpTo" type="number" min="1" value="1" style="width:70px; padding:6px 8px; border-radius:8px; border:1px solid #2a3f5a; background:#0b1119; color:#e6edf3">
          <button class="btn" id="btnGo">Go</button>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
  <div class="lb-inner">
    <button class="lb-btn lb-close" id="lbClose" title="Close (Esc)">‚úï</button>
    <img id="lbImg" class="lb-img" alt="preview"/>
    <div class="lb-actions">
      <button class="lb-btn" id="lbPrev" title="Prev (‚Üê)">‚óÄ</button>
      <button class="lb-btn" id="lbNext" title="Next (‚Üí)">‚ñ∂</button>
    </div>
    <div class="lb-meta">
      <div id="lbCaption">Preview</div>
      <div class="lb-hint">
        <button class="btn" id="lbDownload">Download</button>
        <span style="margin-left:8px">Esc to close ¬∑ ‚Üê / ‚Üí to navigate</span>
      </div>
    </div>
  </div>
</div>

<script>
// ---------- helpers ----------
const api = p => (p && p.startsWith('http')) ? p : `${location.origin}${p}`;

function mimeToExt(mime){
  if(!mime) return '';
  const m = mime.toLowerCase();
  if(m.includes('jpeg') || m.includes('jpg')) return 'jpg';
  if(m.includes('png')) return 'png';
  if(m.includes('webp')) return 'webp';
  if(m.includes('gif')) return 'gif';
  if(m.includes('bmp')) return 'bmp';
  if(m.includes('tiff')) return 'tif';
  return '';
}

async function downloadItem(it){
  try{
    const url = api(`/api/images/${it.id}/download`);
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('download failed');
    const blob = await resp.blob();
    const ext = mimeToExt(it.mime) || mimeToExt(resp.headers.get('Content-Type')) || 'bin';
    const name = `${it.id}.${ext}`;

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }catch(e){
    alert('Download failed.');
  }
}

// ÂÖºÂÆπ‰∏§ÁßçËøîÂõûÂΩ¢ÊÄÅÔºö[{category,count}, ...] Êàñ {items:[...]}
async function fetchCategories(){
  try{
    const r = await fetch(api('/api/analytics/category_breakdown'));
    if(!r.ok) return [];
    const data = await r.json();
    const rows = Array.isArray(data) ? data : (data.items || []);
    return rows
      .map(x => ({ c: (x.category || '').trim(), n: x.count || 0 }))
      .filter(x => x.c && x.c !== 'uncategorized' && x.n > 0)
      .sort((a,b)=> a.c.localeCompare(b.c))
      .map(x => x.c);
  }catch(_){ return []; }
}

async function fetchImages({category='', order='desc', limit=24, page=1}={}){
  const offset = Math.max(0, (page-1)*limit);
  const q = new URLSearchParams({ order, limit, offset });
  if (category) q.set('category', category);
  const r = await fetch(api('/api/images?' + q.toString()));
  if(!r.ok) throw new Error('list images failed');
  return r.json(); // { items:[...], total: N }
}

function imgCard(it, idx){
  const el = document.createElement('div');
  el.className = 'thumb-card';
  const thumbUrl = api(`/api/images/${it.id}/thumb`);
  el.innerHTML = `
    <img src="${thumbUrl}" alt="#${it.id}" title="Click to preview">
    <div class="thumb-meta">
      <span>#${it.id} ¬∑ ${(it.category||'‚Äî')}</span>
      <span>
        <a href="javascript:void(0)" class="link" style="margin-right:8px" data-dl>download</a>
        <a href="/#similar=${it.id}" class="link">similar</a>
      </span>
    </div>`;
  // ÁÇπÂáªÁº©Áï•Âõæ -> È¢ÑËßà
  el.querySelector('img').onclick = () => openLightbox(idx);
  // ‰∏ãËΩΩÊåâÈíÆ
  el.querySelector('[data-dl]').onclick = () => downloadItem(it);
  return el;
}

// ---------- State ----------
let state = {
  category: '',
  order: 'desc',
  limit: 24,
  page: 1,
  total: 0,
  totalPages: 1
};
let currentItems = []; // ÂΩìÂâçÈ°µÁöÑ items
let currentIndex = -1; // lightbox Á¥¢Âºï

function updatePagerUI(){
  state.totalPages = Math.max(1, Math.ceil((state.total || 0) / state.limit));
  document.getElementById('pageInfo').textContent = `Page ${state.page} of ${state.totalPages}`;
  document.getElementById('jumpTo').value = state.page;
}

async function load(reset=false){
  if(reset){ state.page = 1; }
  const data = await fetchImages(state);
  const items = data.items || [];
  currentItems = items;            // Â≠òÁªô lightbox ‰ΩøÁî®
  state.total = Number.isFinite(data.total) ? data.total : (state.page-1)*state.limit + items.length; // fallback
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  items.forEach((it, i) => grid.appendChild(imgCard(it, i)));
  updatePagerUI();
}

// ---------- Lightbox ----------
function openLightbox(idx){
  if(idx<0 || idx>=currentItems.length) return;
  currentIndex = idx;
  const it = currentItems[idx];
  const full = api(`/api/images/${it.id}/view`);
  document.getElementById('lbImg').src = full;
  document.getElementById('lbCaption').textContent = `#${it.id} ¬∑ ${(it.category||'‚Äî')}`;
  document.getElementById('lightbox').classList.add('show');

  // ÁªëÂÆö‰∏ãËΩΩÂΩìÂâçÈ°π
  const btn = document.getElementById('lbDownload');
  btn.onclick = () => downloadItem(it);
}
function closeLightbox(){ document.getElementById('lightbox').classList.remove('show'); }
function nextLightbox(){ if(!currentItems.length) return; openLightbox((currentIndex+1)%currentItems.length); }
function prevLightbox(){ if(!currentItems.length) return; openLightbox((currentIndex-1+currentItems.length)%currentItems.length); }
document.getElementById('lbClose').onclick = closeLightbox;
document.getElementById('lbNext').onclick = nextLightbox;
document.getElementById('lbPrev').onclick = prevLightbox;
document.getElementById('lightbox').addEventListener('click', e => {
  if(e.target.id === 'lightbox') closeLightbox();
});
window.addEventListener('keydown', e => {
  const on = document.getElementById('lightbox').classList.contains('show');
  if(!on) return;
  if(e.key === 'Escape') closeLightbox();
  if(e.key === 'ArrowRight') nextLightbox();
  if(e.key === 'ArrowLeft') prevLightbox();
});

// ---------- Events ----------
(async function boot(){
  // Â°´ÂÖÖÁ±ªÁõÆÈÄâÈ°πÔºà‰∏çÂê´ uncategorizedÔºâ
  const cats = await fetchCategories();
  const sel = document.getElementById('f_category');
  cats.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    sel.appendChild(opt);
  });

  document.getElementById('btnApply').onclick = ()=> {
    state.category = document.getElementById('f_category').value;
    state.order    = document.getElementById('f_order').value;
    state.limit    = parseInt(document.getElementById('f_limit').value,10) || 24;
    load(true);
  };

  document.getElementById('btnReset').onclick = ()=> {
    document.getElementById('f_category').value = '';
    document.getElementById('f_order').value = 'desc';
    document.getElementById('f_limit').value = '24';
    state = { category:'', order:'desc', limit:24, page:1, total:0, totalPages:1 };
    load(true);
  };

  document.getElementById('btnPrev').onclick = ()=> {
    if (state.page > 1){ state.page -= 1; load(false); }
  };
  document.getElementById('btnNext').onclick = ()=> {
    if (state.page < state.totalPages){ state.page += 1; load(false); }
  };
  document.getElementById('btnGo').onclick = ()=> {
    const p = parseInt(document.getElementById('jumpTo').value, 10) || 1;
    state.page = Math.min(Math.max(1, p), state.totalPages);
    load(false);
  };

  // initial load
  load(true);
})();
</script>
</body>
</html>
