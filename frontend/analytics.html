<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image Drive ¬∑ Analytics</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121822; --card:#0f1520; --border:#1f2a3a;
      --fg:#e6edf3; --muted:#99a7b4; --accent:#6aa9ff; --ok:#a3ffcb;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      --w:1280px;
    }
    *{box-sizing:border-box}
    html,body{min-height:100%; overflow:auto; -webkit-overflow-scrolling:touch;}
    body{
      margin:0; color:var(--fg); background:
        radial-gradient(1200px 800px at 10% -10%, #12243a 0%, transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, #1a2f4a 0%, transparent 60%),
        var(--bg);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Microsoft Yahei","PingFang SC","Noto Sans SC",sans-serif;
    }
    header{position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(10,14,20,.9), rgba(10,14,20,.65));
      border-bottom:1px solid var(--border);
    }
    .bar{max-width:var(--w); margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700}
    .logo{width:28px;height:28px; display:grid; place-items:center; border-radius:8px; background:linear-gradient(135deg, var(--accent), #4c78ff); box-shadow:0 6px 20px rgba(76,120,255,.35)}
    .spacer{flex:1}
    a.link {color:var(--accent); text-decoration:none}
    .pill{padding:8px 12px; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:linear-gradient(180deg, #0b1119, #0e151f); cursor:pointer}
    .container{max-width:var(--w); margin:16px auto 40px; padding:0 18px 30px;}
    .controls{display:flex; align-items:center; gap:14px; flex-wrap:wrap; margin-bottom:12px}
    select,input[type="text"]{padding:9px 10px; border-radius:10px; border:1px solid var(--border); background:#0b1119; color:var(--fg); width:190px}
    label{color:var(--muted); font-size:13px; display:flex; align-items:center; gap:6px}
    .btn{padding:9px 12px; border-radius:10px; border:1px solid #2a3f5a; background:linear-gradient(180deg,#18314c,#142a40); color:var(--fg); cursor:pointer}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, #0f1520, #0b1119); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; min-height:300px}
    .card h3{margin:0; padding:12px 14px; border-bottom:1px solid var(--border); font-size:16px}
    .canvas-wrap{position:relative; padding:8px 10px 14px}
    canvas{width:100%; height:320px; display:block}
    .legend{display:flex; gap:12px; padding:0 14px 10px; color:var(--muted); font-size:12px}

    /* Êñ∞Â¢ûÔºöÈ•ºÂõæÁöÑËØ¶ÁªÜÂõæ‰æãÂàóË°® */
    .legend-list{display:flex; flex-wrap:wrap; gap:10px 16px; padding:0 14px 14px}
    .legend-item{display:inline-flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); background:#0b1119; border:1px solid var(--border); padding:6px 8px; border-radius:999px}
    .legend-dot{width:10px; height:10px; border-radius:50%; flex:0 0 10px; border:1px solid rgba(255,255,255,.25)}

    .tooltip{position:fixed; pointer-events:none; background:#101621; border:1px solid #24334a; padding:6px 8px; border-radius:8px; color:#e6edf3; font-size:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; transform:translateY(6px); transition:opacity .12s, transform .12s}
    .empty{color:var(--muted); font-size:13px; padding:14px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <div class="logo">üìà</div>
      <div>Image Drive <small>¬∑ Analytics</small></div>
    </div>
    <div class="spacer"></div>
    <a href="/" class="link">‚Üê Back to Studio</a>
  </div>
</header>

<div class="container">
  <div class="controls">
    <label>Window (days)
      <select id="win">
        <option>7</option><option>14</option><option>30</option><option selected>60</option><option>90</option><option>180</option>
      </select>
    </label>
    <label class="checkbox"><input type="checkbox" id="compact" checked/> compact empty weeks</label>
    <label class="checkbox"><input type="checkbox" id="cum" checked/> cumulative line</label>
    <label>Time zone <input id="tz" type="text" placeholder="e.g. +08:00 (optional)"/></label>
    <button class="btn" id="refresh">Refresh</button>
    <button class="btn" id="dlcsv">Download CSV</button>
    <button class="btn" id="dljson">Download JSON</button>
  </div>

  <div class="grid">
    <!-- Daily -->
    <div class="card">
      <h3>Uploads by Day</h3>
      <div class="canvas-wrap"><canvas id="cDay"></canvas><div id="emptyDay" class="empty" style="display:none">No data</div></div>
      <div class="legend"><span>Bars: daily uploads</span><span id="legendCum" style="display:none">‚Ä¢ Line: cumulative (same window)</span></div>
    </div>

    <!-- Weekly -->
    <div class="card">
      <h3>Uploads by Week</h3>
      <div class="canvas-wrap"><canvas id="cWeek"></canvas><div id="emptyWeek" class="empty" style="display:none">No data</div></div>
      <div class="legend"><span>Bars: weekly uploads</span></div>
    </div>

    <!-- Categories + legend -->
    <div class="card">
      <h3>Categories</h3>
      <div class="canvas-wrap"><canvas id="cCat"></canvas><div id="emptyCat" class="empty" style="display:none">No data</div></div>
      <div id="legendCat" class="legend-list"></div>
    </div>

    <!-- MIME + legend -->
    <div class="card">
      <h3>MIME Types</h3>
      <div class="canvas-wrap"><canvas id="cMime"></canvas><div id="emptyMime" class="empty" style="display:none">No data</div></div>
      <div id="legendMime" class="legend-list"></div>
    </div>
  </div>
</div>

<div id="tip" class="tooltip"></div>

<script>
const api = p => `${location.origin}${p}`;
const tip = document.getElementById('tip');

/* ---------- tiny chart helpers (no CDN) ---------- */
function makeCtx(canvas){ const dpr = Math.max(1, devicePixelRatio||1); const rect = canvas.getBoundingClientRect(); canvas.width = Math.round(rect.width*dpr); canvas.height = Math.round(320*dpr); const ctx = canvas.getContext('2d'); ctx.scale(dpr,dpr); return ctx; }

function barChart(canvas, data, opts={}){
  const ctx = makeCtx(canvas);
  const W = canvas.getBoundingClientRect().width, H = 300;
  const left=40, right=10, top=10, bottom=28;
  const innerW=W-left-right, innerH=H-top-bottom;

  const vals = data.map(d=>d.v);
  const max = Math.max(1, Math.max(...vals, 0));
  const bw = Math.max(2, innerW / Math.max(1,data.length));
  const color = opts.color || '#6aa9ff';
  const labels = data.map(d=>d.k);

  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#1f2a3a'; ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(left, top); ctx.lineTo(left, H-bottom); ctx.lineTo(W-right, H-bottom);
  ctx.stroke();

  const targetHeights = data.map(d=> (d.v/max)*innerH );
  let t = 0;
  function draw(){
    t = Math.min(1, t + 0.08);
    ctx.fillStyle = color;
    for(let i=0;i<data.length;i++){
      const bh = targetHeights[i] * t;
      const x = left + i*bw + 1;
      const y = H-bottom - bh;
      ctx.fillRect(x, y, Math.max(1,bw-2), bh);
    }
    ctx.fillStyle='#99a7b4'; ctx.font='12px system-ui';
    const step = Math.ceil(data.length/8);
    for(let i=0;i<data.length;i+=step){
      const x = left + i*bw + bw/2;
      const txt = labels[i];
      ctx.save(); ctx.translate(x, H-bottom+14); ctx.rotate(-Math.PI/4);
      ctx.fillText(txt, 0, 0); ctx.restore();
    }
    if(t<1) requestAnimationFrame(draw);
  }
  draw();

  canvas.onmousemove = (e)=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left - left;
    if(x<0 || x>innerW){ tip.style.opacity=0; return; }
    const i = Math.floor(x / bw);
    if(i<0 || i>=data.length){ tip.style.opacity=0; return; }
    tip.innerHTML = `<b>${labels[i]}</b><br/>${data[i].v}`;
    tip.style.opacity=1;
    tip.style.transform='translateY(0)';
    tip.style.left = (e.clientX+12)+'px';
    tip.style.top = (e.clientY+12)+'px';
  };
  canvas.onmouseleave = ()=>{ tip.style.opacity=0; tip.style.transform='translateY(6px)'; };
}

function lineChartOverlay(canvas, data, opts={}){
  const ctx = canvas.getContext('2d');
  const W = canvas.getBoundingClientRect().width, H = 300;
  const left=40, right=10, top=10, bottom=28;
  const innerW=W-left-right, innerH=H-top-bottom;

  const vals = data.map(d=>d.v);
  const max = Math.max(1, Math.max(...vals, 0));
  const step = innerW / Math.max(1, data.length-1);
  ctx.strokeStyle = opts.color || '#a3ffcb';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<data.length;i++){
    const x = left + i*step;
    const y = H-bottom - (data[i].v/max)*innerH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

function pieChart(canvas, rows){
  const ctx = makeCtx(canvas);
  const W = canvas.getBoundingClientRect().width, H = 300;
  const cx=W/2, cy=H/2, r=Math.min(W,H)/2 - 20;
  const total = rows.reduce((a,b)=>a+b.v,0) || 1;
  let a0=-Math.PI/2;
  const colors = rows.map((_,i)=>`hsl(${(i*57)%360} 70% 55%)`);

  ctx.clearRect(0,0,W,H);
  rows.forEach((row,i)=>{
    const ang = (row.v/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a0+ang);
    ctx.closePath();
    ctx.fillStyle=colors[i];
    ctx.fill();
    a0+=ang;
  });

  canvas.onmousemove=(e)=>{
    const rect=canvas.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const dx=x-cx, dy=y-cy; const dist=Math.hypot(dx,dy);
    if(dist>r){ tip.style.opacity=0; return; }
    let ang=Math.atan2(dy,dx); if(ang< -Math.PI/2) ang+=2*Math.PI;
    let sweep= -Math.PI/2;
    let found=-1;
    for(let i=0;i<rows.length;i++){
      const a=(rows[i].v/total)*Math.PI*2;
      if(ang>=sweep && ang<=sweep+a){ found=i; break; }
      sweep+=a;
    }
    if(found>=0){
      const p=((rows[found].v/total)*100).toFixed(1);
      tip.innerHTML = `<b>${rows[found].k}</b><br/>${rows[found].v} (${p}%)`;
      tip.style.opacity=1; tip.style.transform='translateY(0)';
      tip.style.left=(e.clientX+12)+'px'; tip.style.top=(e.clientY+12)+'px';
    }else{ tip.style.opacity=0; }
  };
  canvas.onmouseleave=()=>{ tip.style.opacity=0; tip.style.transform='translateY(6px)'; };

  // ÊääÈ¢úËâ≤ËøîÂõûÁªôË∞ÉÁî®ÊñπÁî®‰∫éÁîüÊàêÊñáÂ≠óÂõæ‰æã
  return colors;
}

/* ---------- fetch + render ---------- */
async function loadSummary(){
  const days = parseInt(document.getElementById('win').value, 10) || 60;
  const compact = document.getElementById('compact').checked ? 1 : 0;
  const cum = document.getElementById('cum').checked ? 1 : 0;
  const tz = (document.getElementById('tz').value || '').trim();

  const qs = new URLSearchParams({ days, compact, with_cum: cum });
  if(tz) qs.set('tz', tz);

  const resp = await fetch(api(`/api/analytics/summary?${qs.toString()}`));
  if(!resp.ok){
    console.error('summary failed', await resp.text());
    alert('Failed to load analytics summary.');
    return;
  }
  const j = await resp.json();
  renderAll(j, { cum, days });
}

function ensureNonEmpty(arr){ return Array.isArray(arr) && arr.length>0; }

function setLegendList(containerId, rows, colors){
  const el = document.getElementById(containerId);
  if(!el) return;
  el.innerHTML = '';
  if(!ensureNonEmpty(rows)) return;
  const total = rows.reduce((a,b)=>a+b.v,0) || 1;
  rows.forEach((r, i)=>{
    const pct = (r.v/total*100).toFixed(1);
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<span class="legend-dot" style="background:${colors[i]}"></span>
                      <span>${(r.k||'(unknown)').replace(/</g,'&lt;')}</span>
                      <span>¬∑ ${r.v}</span>
                      <span>¬∑ ${pct}%</span>`;
    el.appendChild(item);
  });
}

function renderAll(j, opts){
  const dByDay = (j.by_day||[]).map(o=>({k:o.date, v:o.count, cum:o.cum}));
  const dByWeek= (j.by_week||[]).map(o=>({k:o.week, v:o.count}));
  const dCat   = (j.category||[]).map(o=>({k:o.category||'(uncategorized)', v:o.count}));
  const dMime  = (j.mime||[]).map(o=>({k:o.mime||'(unknown)', v:o.count}));

  // Day
  const cDay = document.getElementById('cDay');
  document.getElementById('emptyDay').style.display = ensureNonEmpty(dByDay)?'none':'block';
  if(ensureNonEmpty(dByDay)){
    barChart(cDay, dByDay.map(x=>({k:x.k.slice(5), v:x.v})), {color:'#6aa9ff'});
    if(opts.cum){
      lineChartOverlay(cDay, dByDay.map(x=>({k:x.k, v:x.cum||0})), {color:'#a3ffcb'});
      document.getElementById('legendCum').style.display='inline';
    }else{
      document.getElementById('legendCum').style.display='none';
    }
  }

  // Week
  const cWeek = document.getElementById('cWeek');
  document.getElementById('emptyWeek').style.display = ensureNonEmpty(dByWeek)?'none':'block';
  if(ensureNonEmpty(dByWeek)){
    barChart(cWeek, dByWeek, {color:'#9fb6ff'});
  }

  // Categories
  const cCat = document.getElementById('cCat');
  document.getElementById('emptyCat').style.display = ensureNonEmpty(dCat)?'none':'block';
  if(ensureNonEmpty(dCat)){
    const colors = pieChart(cCat, dCat);
    setLegendList('legendCat', dCat, colors);
  }else{
    document.getElementById('legendCat').innerHTML='';
  }

  // MIME
  const cMime = document.getElementById('cMime');
  document.getElementById('emptyMime').style.display = ensureNonEmpty(dMime)?'none':'block';
  if(ensureNonEmpty(dMime)){
    const colors = pieChart(cMime, dMime);
    setLegendList('legendMime', dMime, colors);
  }else{
    document.getElementById('legendMime').innerHTML='';
  }
}

/* ---------- export ---------- */
function download(url, filename){
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),0);
}
document.getElementById('dlcsv').onclick = ()=>{
  const days = document.getElementById('win').value;
  const qs = new URLSearchParams({ target:'summary', format:'csv', days });
  download(api(`/api/analytics/export?${qs}`), `analytics_summary_${days}d.csv`);
};
document.getElementById('dljson').onclick = ()=>{
  const days = document.getElementById('win').value;
  const qs = new URLSearchParams({ days });
  download(api(`/api/analytics/summary?${qs}`), `analytics_summary_${days}d.json`);
};

document.getElementById('refresh').onclick = loadSummary;

/* auto boot */
window.addEventListener('load', loadSummary);
</script>
</body>
</html>
