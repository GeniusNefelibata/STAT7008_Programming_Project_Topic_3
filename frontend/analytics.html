<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Image Drive ¬∑ Analytics</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --card:#0f1520; --border:#1f2a3a;
    --fg:#e6edf3; --muted:#99a7b4; --accent:#6aa9ff; --ok:#a3ffcb; --danger:#ff6a6a;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    --w:1280px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Microsoft Yahei","PingFang SC","Noto Sans SC", sans-serif;
    background:
      radial-gradient(1200px 800px at 10% -10%, #12243a 0%, transparent 60%),
      radial-gradient(1000px 600px at 110% 10%, #1a2f4a 0%, transparent 60%),
      var(--bg);
  }
  header{position:sticky; top:0; z-index:5; backdrop-filter: blur(8px);
    background:linear-gradient(180deg, rgba(10,14,20,.9), rgba(10,14,20,.65));
    border-bottom:1px solid var(--border);
  }
  .bar{max-width:var(--w); margin:0 auto; padding:16px 20px; display:flex; align-items:center; gap:14px}
  .brand{display:flex; align-items:center; gap:10px; font-weight:700}
  .logo{width:28px;height:28px;display:grid;place-items:center;border-radius:8px;background:linear-gradient(135deg,var(--accent),#4c78ff);box-shadow:0 6px 20px rgba(76,120,255,.35)}
  .spacer{flex:1}
  a.link{color:var(--accent);text-decoration:none}
  .container{max-width:var(--w); margin:18px auto 28px; padding:0 20px}

  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
  @media (max-width:1100px){ .grid2{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg,#0f1520,#0b1119); border:1px solid var(--border);
        border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
  .card h3{margin:0 0 10px}
  .meta{color:var(--muted);font-size:13px}

  .kpis{display:grid; grid-template-columns: repeat(4,1fr); gap:12px}
  @media (max-width:900px){.kpis{grid-template-columns: repeat(2,1fr)}}
  .kpi{padding:14px;border:1px solid var(--border); border-radius:14px; background:linear-gradient(180deg,#0b1119,#0e151f)}
  .kpi .label{color:var(--muted);font-size:12px}
  .kpi .value{font-size:22px;font-weight:700;margin-top:6px}

  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .btn{padding:9px 12px; border-radius:10px; border:1px solid #2a3f5a; background:linear-gradient(180deg,#18314c,#142a40); color:var(--fg); cursor:pointer}
  .btn:hover{filter:brightness(1.07)}
  .hint{color:var(--muted); font-size:12px}

  /* table */
  table{width:100%; border-collapse: collapse; margin-top:8px; font-size:14px}
  th, td{padding:10px 8px; border-bottom:1px solid var(--border); text-align:left}
  th{color:var(--muted); font-weight:600}
  tr:hover td{background:rgba(255,255,255,.02)}
  .num{text-align:right}

  /* bar chart (canvas) */
  canvas{width:100%; height:280px; display:block; background:#0c1118; border:1px solid var(--border); border-radius:12px}

  /* samples grid */
  .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:10px; margin-top:10px}
  .thumb{width:100%; aspect-ratio:4/3; object-fit:cover; border:1px solid var(--border); border-radius:10px; background:#0b1119}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand"><div class="logo">üìä</div><div>Image Drive <small class="meta">¬∑ Analytics</small></div></div>
    <div class="spacer"></div>
    <a class="link" href="/">‚Üê Back to Studio</a>
  </div>
</header>

<div class="container">

  <!-- KPIs -->
  <section class="card">
    <h3>Overview</h3>
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">Images</div><div class="value" id="k_images">-</div></div>
      <div class="kpi"><div class="label">Total Size (MB)</div><div class="value" id="k_mb">-</div></div>
      <div class="kpi"><div class="label">Avg WxH (px)</div><div class="value" id="k_dims">-</div></div>
      <div class="kpi"><div class="label">Sizes p50 / p90 / p99 (KB)</div><div class="value" id="k_pct">-</div></div>
    </div>
    <div class="meta" style="margin-top:8px" id="k_note"></div>
  </section>

  <div class="grid2" style="margin-top:16px">

    <!-- Á±ªÂà´ÂàÜÂ∏É -->
    <section class="card">
      <h3>Category Distribution</h3>
      <div class="row" style="justify-content:space-between">
        <div class="hint">Data from GET /api/analytics/summary</div>
        <div class="row">
          <button class="btn" id="btnExport">Export CSV</button>
          <button class="btn" id="btnRefresh">Refresh</button>
        </div>
      </div>
      <canvas id="bar"></canvas>
      <table id="tbl">
        <thead><tr><th>Category</th><th class="num">Count</th><th class="num">% of total</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint">Tip: click a row to preview samples below.</div>
    </section>

    <!-- Á±ªÂà´Ê†∑‰æã -->
    <section class="card">
      <h3>Samples <span class="meta" id="sampleTitle"></span></h3>
      <div id="samples" class="grid"></div>
    </section>
  </div>

</div>

<script>
const api = p => (p && p.startsWith('http')) ? p : `${location.origin}${p}`;

async function fetchSummary(){
  const r = await fetch(api('/api/analytics/summary'));
  if(!r.ok) throw new Error('summary failed');
  return r.json();
}
async function fetchBreakdown(){
  const r = await fetch(api('/api/analytics/category_breakdown'));
  if(!r.ok) throw new Error('breakdown failed');
  return r.json();
}
function fmt(n, d=0){ if(n==null) return '-'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d}); }

function drawBar(canvas, items, total){
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);

  // padding
  const pad = {l:40, r:10, t:10, b:24};
  const w = canvas.clientWidth - pad.l - pad.r;
  const h = canvas.clientHeight - pad.t - pad.b;

  const maxV = Math.max(1, ...items.map(x=>x.count));
  const bw = Math.max(14, w / items.length * 0.75);
  const gap = (w - bw * items.length) / Math.max(1, items.length-1);

  // axes
  const baseX = pad.l, baseY = pad.t + h;
  ctx.strokeStyle = '#203046'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(baseX, pad.t); ctx.lineTo(baseX, baseY); ctx.lineTo(baseX+w, baseY); ctx.stroke();

  // bars
  items.forEach((it, i)=>{
    const x = baseX + i*(bw+gap);
    const y = baseY - (it.count / maxV) * h;
    // gradient
    const g = ctx.createLinearGradient(0,y,0,baseY);
    g.addColorStop(0,'#6aa9ff'); g.addColorStop(1,'#4c78ff');
    ctx.fillStyle = g;
    ctx.fillRect(x, y, bw, baseY-y);
  });

  // labels (x)
  ctx.fillStyle = '#99a7b4'; ctx.font = '12px system-ui, -apple-system, Segoe UI';
  ctx.textAlign = 'center';
  items.forEach((it, i)=>{
    const x = baseX + i*(bw+gap) + bw/2;
    ctx.fillText(it.category.length>10? it.category.slice(0,10)+'‚Ä¶' : it.category, x, baseY+16);
  });
}

function renderSummary(data){
  const total = data.totals?.images || 0;
  document.getElementById('k_images').textContent = fmt(total);
  document.getElementById('k_mb').textContent = fmt(data.totals?.mb, 2);
  document.getElementById('k_dims').textContent = `${fmt(data.dimensions?.avg_width,1)} √ó ${fmt(data.dimensions?.avg_height,1)}`;
  const p50 = data.sizes_kb?.p50, p90 = data.sizes_kb?.p90, p99 = data.sizes_kb?.p99;
  document.getElementById('k_pct').textContent = `${fmt(p50,1)} / ${fmt(p90,1)} / ${fmt(p99,1)}`;
  const note = `Avg size ${fmt(data.sizes_kb?.avg,1)} KB ¬∑ Categories: ${data.by_category?.length||0}`;
  document.getElementById('k_note').textContent = note;

  // table
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  const items = (data.by_category || []).map(x=>({category: x.category, count: x.count}));
  items.forEach(row=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.category}</td><td class="num">${fmt(row.count)}</td><td class="num">${ total? (row.count*100/total).toFixed(1) : '-' }%</td>`;
    tr.addEventListener('click', ()=> loadSamples(row.category));
    tbody.appendChild(tr);
  });

  // bar
  drawBar(document.getElementById('bar'), items, total);
}

async function loadSamples(category){
  document.getElementById('sampleTitle').textContent = category ? `¬∑ ${category}` : '';
  const grid = document.getElementById('samples');
  grid.innerHTML = '<div class="meta">Loading‚Ä¶</div>';
  const rows = await fetchBreakdown(); // [{category,count,sample_ids:[]},...]
  const hit = rows.find(r => (r.category || 'uncategorized') === (category || 'uncategorized'));
  if(!hit){ grid.innerHTML = '<div class="meta">No samples.</div>'; return; }
  grid.innerHTML = '';
  (hit.sample_ids || []).forEach(id=>{
    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = api(`/api/images/${id}/view`);
    img.alt = `#${id}`;
    grid.appendChild(img);
  });
}

function exportCSV(byCategory){
  const rows = [['category','count']];
  (byCategory||[]).forEach(x=> rows.push([x.category, x.count]));
  const csv = rows.map(r => r.map(v=>{
    const s = String(v??''); return s.includes(',') ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'category_distribution.csv';
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}

async function boot(){
  try{
    const data = await fetchSummary();
    renderSummary(data);
    // ÈªòËÆ§ÈÄâÁ¨¨‰∏ÄÁ±ªÂ±ïÁ§∫Ê†∑‰æã
    if(data.by_category && data.by_category.length){ loadSamples(data.by_category[0].category); }
    document.getElementById('btnExport').onclick = ()=> exportCSV(data.by_category||[]);
    document.getElementById('btnRefresh').onclick = async ()=>{ const d=await fetchSummary(); renderSummary(d); };
    window.addEventListener('resize', async ()=>{ const d=await fetchSummary(); renderSummary(d); }, {passive:true});
  }catch(e){
    document.body.innerHTML = `<div style="max-width:720px;margin:80px auto;color:#e6edf3;font-family:system-ui">
      <h2>Analytics page</h2>
      <p style="color:#ff6a6a">Failed to load analytics API. Check that the Flask server is running, and the blueprint <code>analytics</code> is registered.</p>
      <pre style="padding:10px;border:1px solid #1f2a3a;border-radius:10px;background:#0b1119;color:#99a7b4">${e}</pre>
      <p class="meta">Requires: <code>/api/analytics/summary</code>, <code>/api/analytics/category_breakdown</code></p>
    </div>`;
  }
}

boot();
</script>
</body>
</html>
