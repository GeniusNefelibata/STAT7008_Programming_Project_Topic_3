<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEURAL DRIVE // ANALYTICS</title>

  <!-- 引入字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;600;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

  <!-- 引入 Chart.js 用于图表 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- Cyberpunk Theme (Consistent with index.html) --- */
    :root {
      --bg-core: #050505; --bg-panel: rgba(10, 15, 20, 0.7);
      --neon-cyan: #00f3ff; --neon-magenta: #ff0055; --neon-yellow: #fcee0a;
      --grid-color: rgba(0, 243, 255, 0.07); --border-dim: rgba(0, 243, 255, 0.15);
      --text-main: #e0f7fa; --text-muted: #617d8a;
      --font-hud: 'Rajdhani', sans-serif; --font-mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; outline: none; }
    html, body { height: 100%; margin: 0; overflow: hidden; }

    body {
      background-color: var(--bg-core); color: var(--text-main); font-family: var(--font-hud);
      background-image:
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px),
        radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.1) 0%, transparent 60%);
      background-size: 40px 40px, 40px 40px, 100% 100%;
      background-position: center top;
    }

    body::after {
      content: " "; display: block; position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
      background-size: 100% 3px; z-index: 2; pointer-events: none; opacity: 0.4;
    }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-dim);
      height: 70px; display: flex; align-items: center;
    }

    .bar {
      width: 100%; max-width: 1600px; margin: 0 auto; padding: 0 32px;
      display: flex; align-items: center; justify-content: space-between;
    }

    .brand {
      display: flex; align-items: center; gap: 16px;
      font-family: var(--font-hud); font-weight: 700; font-size: 24px;
      letter-spacing: 2px; text-transform: uppercase;
      color: #fff; text-shadow: 0 0 10px var(--neon-cyan);
      cursor: pointer; transition: opacity 0.2s;
    }
    .brand:hover { opacity: 0.8; }

    .logo {
      width: 40px; height: 40px; background: var(--neon-cyan); color: #000;
      clip-path: polygon(20% 0%, 100% 0, 100% 80%, 80% 100%, 0 100%, 0% 20%);
      display: grid; place-items: center; font-size: 22px;
      animation: flicker 4s infinite;
    }
    @keyframes flicker { 0%, 19.9%, 62.9%, 64.9%, 100% { opacity: 1; } 20%, 63% { opacity: 0.5; } }

    .nav-btn {
      font-family: var(--font-mono); font-size: 12px; color: var(--neon-cyan);
      background: transparent; border: 1px solid var(--border-dim);
      padding: 8px 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
      transition: all 0.2s;
    }
    .nav-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

    /* Layout */
    .container {
      max-width: 1600px; margin: 0 auto; padding: 32px;
      height: calc(100vh - 70px); overflow-y: auto;
    }

    /* Controls Bar */
    .controls {
      display: flex; align-items: center; gap: 16px; flex-wrap: wrap; margin-bottom: 24px;
      background: var(--bg-panel); border: 1px solid var(--border-dim);
      padding: 16px; clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
      position: relative;
    }
    .controls::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--neon-cyan); }

    label { font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }

    select, input[type="text"] {
      padding: 8px 12px; background: #000; border: 1px solid var(--border-dim);
      color: var(--neon-cyan); font-family: var(--font-mono); font-size: 12px;
      border-radius: 0; transition: all 0.3s;
    }
    select:focus, input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }

    .btn {
      background: transparent; border: 1px solid var(--border-dim);
      color: var(--neon-cyan); padding: 8px 16px; cursor: pointer;
      font-family: var(--font-hud); font-weight: 700; font-size: 12px; letter-spacing: 1px; text-transform: uppercase;
      transition: all 0.2s; position: relative; overflow: hidden;
    }
    .btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

    /* Grid for Cards */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr} }

    .card {
      background: var(--bg-panel); border: 1px solid var(--border-dim);
      min-height: 320px; position: relative; display: flex; flex-direction: column;
      clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }
    .card h3 {
      margin: 0; padding: 16px 20px; border-bottom: 1px solid var(--border-dim);
      font-family: var(--font-hud); color: var(--neon-cyan); font-size: 16px; letter-spacing: 1px;
    }

    .canvas-wrap { position: relative; padding: 16px; flex: 1; display: flex; flex-direction: column; }
    canvas { width: 100% !important; height: 280px !important; display: block; }

    .legend {
      display: flex; gap: 16px; padding: 0 20px 16px; font-family: var(--font-mono); font-size: 10px; color: var(--text-muted);
    }
    .legend span::before { content: '■ '; color: var(--neon-cyan); margin-right: 4px; }

    /* Custom Legend List for Pie Charts */
    .legend-list { display: flex; flex-wrap: wrap; gap: 10px; padding: 0 20px 20px; }
    .legend-item {
      display: inline-flex; align-items: center; gap: 8px; font-size: 10px; font-family: var(--font-mono);
      color: var(--text-muted); border: 1px solid var(--border-dim); padding: 4px 8px; background: rgba(0,0,0,0.3);
    }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    .empty { text-align: center; padding: 40px; color: var(--text-muted); font-family: var(--font-code); }

    .tooltip {
      position: fixed; pointer-events: none; background: #000; border: 1px solid var(--neon-cyan);
      padding: 8px 12px; color: #fff; font-family: var(--font-mono); font-size: 12px;
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); opacity: 0; z-index: 200;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: var(--border-dim); }
    ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }
  </style>
</head>
<body>

<header>
  <div class="bar">
    <!-- Logo 修复跳转 -->
    <div class="brand" onclick="location.href='http://127.0.0.1:5000/'">
      <div class="logo">A</div>
      <div>NEURAL DRIVE <small style="font-size: 10px; color:var(--neon-magenta); letter-spacing:0">// ANALYTICS</small></div>
    </div>
    <div style="display:flex; gap: 20px;">
        <!-- 导航修复 -->
        <button class="nav-btn" onclick="location.href='http://127.0.0.1:5000/'">← BACK TO STUDIO</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="controls">
    <label>WINDOW (DAYS)
      <select id="win">
        <option>7</option><option>14</option><option>30</option><option selected>60</option><option>90</option><option>180</option>
      </select>
    </label>
    <label class="checkbox"><input type="checkbox" id="compact" checked/> COMPACT EMPTY</label>
    <label class="checkbox"><input type="checkbox" id="cum" checked/> CUMULATIVE LINE</label>
    <label>TIME ZONE <input id="tz" type="text" placeholder="E.G. +08:00" style="width:120px"/></label>
    <button class="btn" id="refresh">REFRESH DATA</button>
    <button class="btn" id="dlcsv">EXPORT CSV</button>
    <button class="btn" id="dljson">EXPORT JSON</button>
  </div>

  <div class="grid">
    <!-- Daily -->
    <div class="card">
      <h3>// UPLOADS BY DAY</h3>
      <div class="canvas-wrap">
        <canvas id="cDay"></canvas>
        <div id="emptyDay" class="empty" style="display:none">// NO DATA STREAM //</div>
      </div>
      <div class="legend"><span>BARS: DAILY</span><span id="legendCum" style="display:none; color:var(--neon-yellow)">• LINE: CUMULATIVE</span></div>
    </div>

    <!-- Weekly -->
    <div class="card">
      <h3>// UPLOADS BY WEEK</h3>
      <div class="canvas-wrap">
        <canvas id="cWeek"></canvas>
        <div id="emptyWeek" class="empty" style="display:none">// NO DATA STREAM //</div>
      </div>
      <div class="legend"><span>BARS: WEEKLY</span></div>
    </div>

    <!-- Categories -->
    <div class="card">
      <h3>// CATEGORY DISTRIBUTION</h3>
      <div class="canvas-wrap">
        <canvas id="cCat"></canvas>
        <div id="emptyCat" class="empty" style="display:none">// NO DATA STREAM //</div>
      </div>
      <div id="legendCat" class="legend-list"></div>
    </div>

    <!-- MIME -->
    <div class="card">
      <h3>// FILE TYPES</h3>
      <div class="canvas-wrap">
        <canvas id="cMime"></canvas>
        <div id="emptyMime" class="empty" style="display:none">// NO DATA STREAM //</div>
      </div>
      <div id="legendMime" class="legend-list"></div>
    </div>
  </div>
</div>

<div id="tip" class="tooltip"></div>

<script>
const api = p => (p && p.startsWith('http')) ? p : `${location.origin}${p}`;
const tip = document.getElementById('tip');

// --- Styling Config ---
const colors = {
  cyan: '#00f3ff',
  magenta: '#ff0055',
  yellow: '#fcee0a',
  grid: 'rgba(0, 243, 255, 0.1)',
  text: '#e0f7fa'
};

/* ---------- Canvas Helpers ---------- */
function makeCtx(canvas){
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.round(rect.width*dpr);
  canvas.height = Math.round(280*dpr);
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  return ctx;
}

function barChart(canvas, data, opts={}){
  const ctx = makeCtx(canvas);
  const W = canvas.getBoundingClientRect().width, H = 280;
  const left=40, right=10, top=20, bottom=30;
  const innerW=W-left-right, innerH=H-top-bottom;

  const vals = data.map(d=>d.v);
  const max = Math.max(1, Math.max(...vals, 0));
  const bw = Math.max(2, innerW / Math.max(1,data.length));
  const color = opts.color || colors.cyan;
  const labels = data.map(d=>d.k);

  ctx.clearRect(0,0,W,H);
  // Grid lines
  ctx.strokeStyle = colors.grid; ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(left, top); ctx.lineTo(left, H-bottom); ctx.lineTo(W-right, H-bottom);
  ctx.stroke();

  const targetHeights = data.map(d=> (d.v/max)*innerH );

  // Draw Bars
  ctx.fillStyle = color;
  for(let i=0;i<data.length;i++){
    const bh = targetHeights[i];
    const x = left + i*bw + 1;
    const y = H-bottom - bh;
    ctx.fillRect(x, y, Math.max(1,bw-2), bh);
  }

  // Draw Labels
  ctx.fillStyle=colors.text; ctx.font='10px JetBrains Mono';
  const step = Math.ceil(data.length/8);
  for(let i=0;i<data.length;i+=step){
    const x = left + i*bw + bw/2;
    const txt = labels[i];
    ctx.save(); ctx.translate(x, H-bottom+14);
    // ctx.rotate(-Math.PI/4); // Optional rotation
    ctx.fillText(txt.substring(0,6), -10, 0);
    ctx.restore();
  }

  // Interaction
  canvas.onmousemove = (e)=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left - left;
    if(x<0 || x>innerW){ tip.style.opacity=0; return; }
    const i = Math.floor(x / bw);
    if(i<0 || i>=data.length){ tip.style.opacity=0; return; }
    tip.innerHTML = `<span style="color:${colors.cyan}">${labels[i]}</span><br/>COUNT: ${data[i].v}`;
    tip.style.opacity=1;
    tip.style.left = (e.clientX+15)+'px';
    tip.style.top = (e.clientY+15)+'px';
  };
  canvas.onmouseleave = ()=>{ tip.style.opacity=0; };
}

function lineChartOverlay(canvas, data, opts={}){
  const ctx = canvas.getContext('2d');
  const W = canvas.getBoundingClientRect().width, H = 280;
  const left=40, right=10, top=20, bottom=30;
  const innerW=W-left-right, innerH=H-top-bottom;

  const vals = data.map(d=>d.v);
  const max = Math.max(1, Math.max(...vals, 0));
  const step = innerW / Math.max(1, data.length-1);

  ctx.strokeStyle = opts.color || colors.yellow;
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<data.length;i++){
    const x = left + i*step;
    const y = H-bottom - (data[i].v/max)*innerH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

function pieChart(canvas, rows){
  const ctx = makeCtx(canvas);
  const W = canvas.getBoundingClientRect().width, H = 280;
  const cx=W/2, cy=H/2, r=Math.min(W,H)/2 - 30;
  const total = rows.reduce((a,b)=>a+b.v,0) || 1;
  let a0=-Math.PI/2;

  // Generating cyberpunk palette for pie slices
  const palette = [colors.cyan, colors.magenta, colors.yellow, '#ffffff', '#555555'];
  const pieColors = rows.map((_,i)=> palette[i % palette.length]);

  ctx.clearRect(0,0,W,H);
  rows.forEach((row,i)=>{
    const ang = (row.v/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a0+ang);
    ctx.closePath();
    ctx.fillStyle=pieColors[i];
    ctx.fill();
    ctx.strokeStyle = '#000'; ctx.lineWidth=2; ctx.stroke();
    a0+=ang;
  });

  canvas.onmousemove=(e)=>{
    const rect=canvas.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const dx=x-cx, dy=y-cy; const dist=Math.hypot(dx,dy);
    if(dist>r){ tip.style.opacity=0; return; }

    let ang=Math.atan2(dy,dx); if(ang< -Math.PI/2) ang+=2*Math.PI;
    let sweep= -Math.PI/2;
    let found=-1;
    for(let i=0;i<rows.length;i++){
      const a=(rows[i].v/total)*Math.PI*2;
      if(ang>=sweep && ang<=sweep+a){ found=i; break; }
      sweep+=a;
    }
    if(found>=0){
      const p=((rows[found].v/total)*100).toFixed(1);
      tip.innerHTML = `<span style="color:${pieColors[found]}">${rows[found].k}</span><br/>${rows[found].v} (${p}%)`;
      tip.style.opacity=1;
      tip.style.left=(e.clientX+15)+'px'; tip.style.top=(e.clientY+15)+'px';
    }else{ tip.style.opacity=0; }
  };
  canvas.onmouseleave=()=>{ tip.style.opacity=0; };

  return pieColors;
}

/* ---------- Data Loading ---------- */
async function loadSummary(){
  const days = parseInt(document.getElementById('win').value, 10) || 60;
  const compact = document.getElementById('compact').checked ? 1 : 0;
  const cum = document.getElementById('cum').checked ? 1 : 0;
  const tz = (document.getElementById('tz').value || '').trim();

  const qs = new URLSearchParams({ days, compact, with_cum: cum });
  if(tz) qs.set('tz', tz);

  try {
    const resp = await fetch(api(`/api/analytics/summary?${qs.toString()}`));
    if(!resp.ok) throw new Error('Fetch failed');
    const j = await resp.json();
    renderAll(j, { cum, days });
  } catch(e) {
    console.log("Using mock data for visualization due to API error or missing endpoint");
    // Fallback Mock Data for Preview
    const mockData = {
        by_day: Array.from({length:10}, (_,i)=>({date:`2023-11-0${i+1}`, count: Math.floor(Math.random()*10), cum: i*5})),
        by_week: Array.from({length:4}, (_,i)=>({week:`W${i+40}`, count: Math.floor(Math.random()*30)})),
        category: [{category:'CYBERPUNK', count:45}, {category:'NATURE', count:12}, {category:'TECH', count:30}],
        mime: [{mime:'image/jpeg', count:60}, {mime:'image/png', count:20}]
    };
    renderAll(mockData, { cum, days });
  }
}

function ensureNonEmpty(arr){ return Array.isArray(arr) && arr.length>0; }

function setLegendList(containerId, rows, pColors){
  const el = document.getElementById(containerId);
  if(!el) return;
  el.innerHTML = '';
  if(!ensureNonEmpty(rows)) return;
  const total = rows.reduce((a,b)=>a+b.v,0) || 1;
  rows.forEach((r, i)=>{
    const pct = (r.v/total*100).toFixed(1);
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<span class="legend-dot" style="background:${pColors[i]}"></span>
                      <span>${(r.k||'(unknown)').toUpperCase()}</span>
                      <span style="color:#fff">· ${r.v}</span>
                      <span style="color:${colors.cyan}">· ${pct}%</span>`;
    el.appendChild(item);
  });
}

function renderAll(j, opts){
  const dByDay = (j.by_day||[]).map(o=>({k:o.date, v:o.count, cum:o.cum}));
  const dByWeek= (j.by_week||[]).map(o=>({k:o.week, v:o.count}));
  const dCat   = (j.category||[]).map(o=>({k:o.category||'(uncategorized)', v:o.count}));
  const dMime  = (j.mime||[]).map(o=>({k:o.mime||'(unknown)', v:o.count}));

  // Day
  const cDay = document.getElementById('cDay');
  document.getElementById('emptyDay').style.display = ensureNonEmpty(dByDay)?'none':'block';
  if(ensureNonEmpty(dByDay)){
    barChart(cDay, dByDay.map(x=>({k:x.k.slice(5), v:x.v})), {color: colors.cyan});
    if(opts.cum){
      lineChartOverlay(cDay, dByDay.map(x=>({k:x.k, v:x.cum||0})), {color: colors.yellow});
      document.getElementById('legendCum').style.display='inline';
    }else{
      document.getElementById('legendCum').style.display='none';
    }
  }

  // Week
  const cWeek = document.getElementById('cWeek');
  document.getElementById('emptyWeek').style.display = ensureNonEmpty(dByWeek)?'none':'block';
  if(ensureNonEmpty(dByWeek)){
    barChart(cWeek, dByWeek, {color: colors.magenta});
  }

  // Categories
  const cCat = document.getElementById('cCat');
  document.getElementById('emptyCat').style.display = ensureNonEmpty(dCat)?'none':'block';
  if(ensureNonEmpty(dCat)){
    const pColors = pieChart(cCat, dCat);
    setLegendList('legendCat', dCat, pColors);
  }

  // MIME
  const cMime = document.getElementById('cMime');
  document.getElementById('emptyMime').style.display = ensureNonEmpty(dMime)?'none':'block';
  if(ensureNonEmpty(dMime)){
    const pColors = pieChart(cMime, dMime);
    setLegendList('legendMime', dMime, pColors);
  }
}

/* ---------- export ---------- */
function download(url, filename){
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),0);
}
document.getElementById('dlcsv').onclick = ()=>{
  const days = document.getElementById('win').value;
  const qs = new URLSearchParams({ target:'summary', format:'csv', days });
  download(api(`/api/analytics/export?${qs}`), `analytics_summary_${days}d.csv`);
};
document.getElementById('dljson').onclick = ()=>{
  const days = document.getElementById('win').value;
  const qs = new URLSearchParams({ days });
  download(api(`/api/analytics/summary?${qs}`), `analytics_summary_${days}d.json`);
};

document.getElementById('refresh').onclick = loadSummary;

window.addEventListener('load', loadSummary);
</script>
</body>
</html>